<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-loading-bar.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.10.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="renren-fast开发文档3.0最新版版权说明 本文档为付费文档，版权归人人开源（renren.io）所有，并保留一切权利，本文档及其描述的内容受有关法律的版权保护，对本文档以任何形式的非法复制、泄露或散布到网络提供下载，都将导致相应的法律责任。  免责声明 本文档仅提供阶段性信息，所含内容可根据项目的实际情况随时更新，以人人开源社区公告为准。如因文档使用不当造成的直接或间接损失，人人开源不承">
<meta property="og:type" content="article">
<meta property="og:title" content="renren-fast开发文档3.0最新版">
<meta property="og:url" content="http://example.com/posts/55ff28b4/index.html">
<meta property="og:site_name" content="swimminghao&#39;s blog">
<meta property="og:description" content="renren-fast开发文档3.0最新版版权说明 本文档为付费文档，版权归人人开源（renren.io）所有，并保留一切权利，本文档及其描述的内容受有关法律的版权保护，对本文档以任何形式的非法复制、泄露或散布到网络提供下载，都将导致相应的法律责任。  免责声明 本文档仅提供阶段性信息，所含内容可根据项目的实际情况随时更新，以人人开源社区公告为准。如因文档使用不当造成的直接或间接损失，人人开源不承">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/7nZ7nU.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/EVCSoB.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/C4IoHO.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/HWqMVn.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/Pli3sp.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/BhpLFE.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/hHJj2Z.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/iAj5t1.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/np520W.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/G7kxHE.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/qsBkIQ.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/xyolW8.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/j1UF4l.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/9d5CTr.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/86h4oq.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/tkisAZ.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/v0K61m.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/bHjijJ.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/zEeaHL.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/tB5WLW.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/DIzny3.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/lH6UMH.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/UGXMhL.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/rLnoLL.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/7XxX9S.png">
<meta property="article:published_time" content="2022-03-16T02:05:00.000Z">
<meta property="article:modified_time" content="2022-06-02T02:18:40.861Z">
<meta property="article:author" content="swimminghao">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="脚手架">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/7nZ7nU.png">


<link rel="canonical" href="http://example.com/posts/55ff28b4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/posts/55ff28b4/","path":"posts/55ff28b4/","title":"renren-fast开发文档3.0最新版"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>renren-fast开发文档3.0最新版 | swimminghao's blog</title>
  




<link rel="dns-prefetch" href="waline-server-nu.vercel.app"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.css"><style>
#needsharebutton-postbottom {
  cursor: pointer;
  height: 26px;
  margin-top: 10px;
  position: relative;
}
#needsharebutton-postbottom .btn {
  border: 1px solid $btn-default-border-color;
  border-radius: 3px;
  display: initial;
  padding: 1px 4px;
}
</style>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">swimminghao's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">34</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">8</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">134</span></a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#renren-fast%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A33-0%E6%9C%80%E6%96%B0%E7%89%88"><span class="nav-number">1.</span> <span class="nav-text">renren-fast开发文档3.0最新版</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%89%88%E6%9D%83%E8%AF%B4%E6%98%8E"><span class="nav-number">2.</span> <span class="nav-text">版权说明</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%8D%E8%B4%A3%E5%A3%B0%E6%98%8E"><span class="nav-number">3.</span> <span class="nav-text">免责声明</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E6%9B%B4%E6%96%B0"><span class="nav-number">4.</span> <span class="nav-text">文档更新</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-1-%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="nav-number">5.</span> <span class="nav-text">第 1 章 项目介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E9%A1%B9%E7%9B%AE%E6%8F%8F%E8%BF%B0"><span class="nav-number">5.1.</span> <span class="nav-text">1.1 项目描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E9%A1%B9%E7%9B%AE%E7%89%B9%E7%82%B9"><span class="nav-number">5.2.</span> <span class="nav-text">1.2 项目特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92"><span class="nav-number">5.3.</span> <span class="nav-text">1.3 数据交互</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">5.4.</span> <span class="nav-text">1.4 开发环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-%E8%8E%B7%E5%8F%96%E5%B8%AE%E5%8A%A9"><span class="nav-number">5.5.</span> <span class="nav-text">1.5 获取帮助</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E9%A1%B9%E7%9B%AE%E6%8F%8F%E8%BF%B0-1"><span class="nav-number">5.6.</span> <span class="nav-text">1.1 项目描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E9%A1%B9%E7%9B%AE%E7%89%B9%E7%82%B9-1"><span class="nav-number">5.7.</span> <span class="nav-text">1.2 项目特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92-1"><span class="nav-number">5.8.</span> <span class="nav-text">1.3 数据交互</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-1"><span class="nav-number">5.9.</span> <span class="nav-text">1.4 开发环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-1-%E8%BD%AF%E4%BB%B6%E9%9C%80%E6%B1%82"><span class="nav-number">5.9.1.</span> <span class="nav-text">1.4.1 软件需求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-2-%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81"><span class="nav-number">5.9.2.</span> <span class="nav-text">1.4.2 下载源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-3-IDEA-%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7"><span class="nav-number">5.9.3.</span> <span class="nav-text">1.4.3 IDEA 开发工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-4-Eclipse-%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7"><span class="nav-number">5.9.4.</span> <span class="nav-text">1.4.4 Eclipse 开发工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-5-%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">5.9.5.</span> <span class="nav-text">1.4.5 创建数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-6-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">5.9.6.</span> <span class="nav-text">1.4.6 修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-7-%E5%89%8D%E7%AB%AF%E9%83%A8%E7%BD%B2"><span class="nav-number">5.9.7.</span> <span class="nav-text">1.4.7 前端部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-%E8%8E%B7%E5%8F%96%E5%B8%AE%E5%8A%A9-1"><span class="nav-number">5.10.</span> <span class="nav-text">1.5 获取帮助</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-2-%E7%AB%A0-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%AF%E6%8C%81"><span class="nav-number">6.</span> <span class="nav-text">第 2 章 数据库支持</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-MySQL-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%AF%E6%8C%81"><span class="nav-number">6.1.</span> <span class="nav-text">2.1 MySQL 数据库支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-Oracle-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%AF%E6%8C%81"><span class="nav-number">6.2.</span> <span class="nav-text">2.2 Oracle 数据库支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-SQL-Server-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%AF%E6%8C%81"><span class="nav-number">6.3.</span> <span class="nav-text">2.3 SQL Server 数据库支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%AF%E6%8C%81"><span class="nav-number">6.4.</span> <span class="nav-text">2.4 PostgreSQL 数据库支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-MySQL-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%AF%E6%8C%81-1"><span class="nav-number">6.5.</span> <span class="nav-text">2.1 MySQL 数据库支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-Oracle-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%AF%E6%8C%81-1"><span class="nav-number">6.6.</span> <span class="nav-text">2.2 Oracle 数据库支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-SQL-Server-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%AF%E6%8C%81-1"><span class="nav-number">6.7.</span> <span class="nav-text">2.3 SQL Server 数据库支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%AF%E6%8C%81-1"><span class="nav-number">6.8.</span> <span class="nav-text">2.4 PostgreSQL 数据库支持</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-3-%E7%AB%A0-%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E6%94%AF%E6%8C%81"><span class="nav-number">7.</span> <span class="nav-text">第 3 章 多数据源支持</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE"><span class="nav-number">7.1.</span> <span class="nav-text">3.1 多数据源配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E4%BD%BF%E7%94%A8"><span class="nav-number">7.2.</span> <span class="nav-text">3.2 多数据源使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E6%BA%90%E7%A0%81%E8%AE%B2%E8%A7%A3"><span class="nav-number">7.3.</span> <span class="nav-text">3.3 源码讲解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE-1"><span class="nav-number">7.4.</span> <span class="nav-text">3.1 多数据源配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">7.5.</span> <span class="nav-text">多数据源的配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E4%BD%BF%E7%94%A8-1"><span class="nav-number">7.6.</span> <span class="nav-text">3.2 多数据源使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E6%BA%90%E7%A0%81%E8%AE%B2%E8%A7%A3-1"><span class="nav-number">7.7.</span> <span class="nav-text">3.3 源码讲解</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-4-%E7%AB%A0-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E8%AE%B2%E8%A7%A3"><span class="nav-number">8.</span> <span class="nav-text">第 4 章 基础知识讲解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Spring-MVC-%E4%BD%BF%E7%94%A8"><span class="nav-number">8.1.</span> <span class="nav-text">4.1 Spring MVC 使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-Swagger-%E4%BD%BF%E7%94%A8"><span class="nav-number">8.2.</span> <span class="nav-text">4.2 Swagger 使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-Mybatis-plus-%E4%BD%BF%E7%94%A8"><span class="nav-number">8.3.</span> <span class="nav-text">4.3 Mybatis-plus 使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Spring-MVC-%E4%BD%BF%E7%94%A8-1"><span class="nav-number">8.4.</span> <span class="nav-text">4.1 Spring MVC 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-Controller-%E6%B3%A8%E8%A7%A3"><span class="nav-number">8.4.1.</span> <span class="nav-text">4.1.1 @Controller 注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-RequestMapping-%E6%B3%A8%E8%A7%A3"><span class="nav-number">8.4.2.</span> <span class="nav-text">4.1.2 @RequestMapping 注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-3-PathVariable-%E6%B3%A8%E8%A7%A3"><span class="nav-number">8.4.3.</span> <span class="nav-text">4.1.3 @PathVariable 注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-4-GetMapping-%E6%B3%A8%E8%A7%A3"><span class="nav-number">8.4.4.</span> <span class="nav-text">4.1.4 @GetMapping 注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-5-RequestBody-%E6%B3%A8%E8%A7%A3"><span class="nav-number">8.4.5.</span> <span class="nav-text">4.1.5 @RequestBody 注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-6-ResponseBody-%E6%B3%A8%E8%A7%A3"><span class="nav-number">8.4.6.</span> <span class="nav-text">4.1.6 @ResponseBody 注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-7-RestController-%E6%B3%A8%E8%A7%A3"><span class="nav-number">8.4.7.</span> <span class="nav-text">4.1.7 @RestController 注解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-Swagger-%E4%BD%BF%E7%94%A8-1"><span class="nav-number">8.5.</span> <span class="nav-text">4.2 Swagger 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-%E6%90%AD%E5%BB%BA-Swagger-%E7%8E%AF%E5%A2%83"><span class="nav-number">8.5.1.</span> <span class="nav-text">4.2.1 搭建 Swagger 环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-Swagger-%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="nav-number">8.5.2.</span> <span class="nav-text">4.2.2 Swagger 常用注解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-Mybatis-plus-%E4%BD%BF%E7%94%A8-1"><span class="nav-number">8.6.</span> <span class="nav-text">4.3 Mybatis-plus 使用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-5-%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="nav-number">9.</span> <span class="nav-text">第 5 章 项目实战</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E9%9C%80%E6%B1%82%E8%AF%B4%E6%98%8E"><span class="nav-number">9.1.</span> <span class="nav-text">5.1 需求说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-number">9.2.</span> <span class="nav-text">5.2 代码生成器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E9%9C%80%E6%B1%82%E8%AF%B4%E6%98%8E-1"><span class="nav-number">9.3.</span> <span class="nav-text">5.1 需求说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-number">9.4.</span> <span class="nav-text">5.1 代码生成器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-6-%E7%AB%A0-%E5%90%8E%E7%AB%AF%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">10.</span> <span class="nav-text">第 6 章 后端源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB"><span class="nav-number">10.1.</span> <span class="nav-text">6.1 前后端分离</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-%E6%9D%83%E9%99%90%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="nav-number">10.2.</span> <span class="nav-text">6.2 权限设计思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-XSS-%E8%84%9A%E6%9C%AC%E8%BF%87%E6%BB%A4"><span class="nav-number">10.3.</span> <span class="nav-text">6.3 XSS 脚本过滤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-SQL-%E6%B3%A8%E5%85%A5"><span class="nav-number">10.4.</span> <span class="nav-text">6.4 SQL 注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-5-Redis-%E7%BC%93%E5%AD%98"><span class="nav-number">10.5.</span> <span class="nav-text">6.5 Redis 缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-6-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="nav-number">10.6.</span> <span class="nav-text">6.6 异常处理机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-7-%E5%90%8E%E7%AB%AF%E6%95%88%E9%AA%8C%E6%9C%BA%E5%88%B6"><span class="nav-number">10.7.</span> <span class="nav-text">6.7 后端效验机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-8-%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97"><span class="nav-number">10.8.</span> <span class="nav-text">6.8 系统日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-9-%E6%B7%BB%E5%8A%A0%E8%8F%9C%E5%8D%95"><span class="nav-number">10.9.</span> <span class="nav-text">6.9 添加菜单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-10-%E6%B7%BB%E5%8A%A0%E8%A7%92%E8%89%B2"><span class="nav-number">10.10.</span> <span class="nav-text">6.10 添加角色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-11-%E6%B7%BB%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98"><span class="nav-number">10.11.</span> <span class="nav-text">6.11 添加管理员</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-12-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97"><span class="nav-number">10.12.</span> <span class="nav-text">6.12 定时任务模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-13-%E4%BA%91%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9D%97"><span class="nav-number">10.13.</span> <span class="nav-text">6.13 云存储模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-14-APP-%E6%A8%A1%E5%9D%97"><span class="nav-number">10.14.</span> <span class="nav-text">6.14 APP 模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB-1"><span class="nav-number">10.15.</span> <span class="nav-text">6.1 前后端分离</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-%E6%9D%83%E9%99%90%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF-1"><span class="nav-number">10.16.</span> <span class="nav-text">6.2 权限设计思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-XSS-%E8%84%9A%E6%9C%AC%E8%BF%87%E6%BB%A4-1"><span class="nav-number">10.17.</span> <span class="nav-text">6.3 XSS 脚本过滤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-SQL-%E6%B3%A8%E5%85%A5-1"><span class="nav-number">10.18.</span> <span class="nav-text">6.4 SQL 注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-5-Redis-%E7%BC%93%E5%AD%98-1"><span class="nav-number">10.19.</span> <span class="nav-text">6.5 Redis 缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-6-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6-1"><span class="nav-number">10.20.</span> <span class="nav-text">6.6 异常处理机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-7-%E5%90%8E%E7%AB%AF%E6%95%88%E9%AA%8C%E6%9C%BA%E5%88%B6-1"><span class="nav-number">10.21.</span> <span class="nav-text">6.7 后端效验机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-8-%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97-1"><span class="nav-number">10.22.</span> <span class="nav-text">6.8 系统日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-9-%E6%B7%BB%E5%8A%A0%E8%8F%9C%E5%8D%95-1"><span class="nav-number">10.23.</span> <span class="nav-text">6.9 添加菜单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-10-%E6%B7%BB%E5%8A%A0%E8%A7%92%E8%89%B2-1"><span class="nav-number">10.24.</span> <span class="nav-text">6.10 添加角色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-11-%E6%B7%BB%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98-1"><span class="nav-number">10.25.</span> <span class="nav-text">6.11 添加管理员</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-12-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97-1"><span class="nav-number">10.26.</span> <span class="nav-text">6.12 定时任务模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-12-1-%E6%96%B0%E5%A2%9E%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="nav-number">10.26.1.</span> <span class="nav-text">6.12.1 新增定时任务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-12-2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">10.26.1.1.</span> <span class="nav-text">6.12.2 源码分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-13-%E4%BA%91%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9D%97-1"><span class="nav-number">10.27.</span> <span class="nav-text">6.13 云存储模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-13-1-%E4%B8%83%E7%89%9B%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">10.27.1.</span> <span class="nav-text">6.13.1 七牛的配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-13-2-%E9%98%BF%E9%87%8C%E4%BA%91%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">10.27.2.</span> <span class="nav-text">6.13.2 阿里云的配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-13-3-%E8%85%BE%E8%AE%AF%E4%BA%91%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">10.27.2.1.</span> <span class="nav-text">6.13.3 腾讯云的配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-13-4-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">10.27.2.2.</span> <span class="nav-text">6.13.4 源码分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-14-APP-%E6%A8%A1%E5%9D%97-1"><span class="nav-number">10.28.</span> <span class="nav-text">6.14 APP 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-14-1-APP-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">10.28.1.</span> <span class="nav-text">6.14.1 APP 的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-14-2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">10.28.2.</span> <span class="nav-text">6.14.2 源码分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC-7-%E7%AB%A0-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"><span class="nav-number">11.</span> <span class="nav-text">第 7 章 生产环境部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-jar-%E5%8C%85%E9%83%A8%E7%BD%B2"><span class="nav-number">11.1.</span> <span class="nav-text">7.1 jar 包部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-docker-%E9%83%A8%E7%BD%B2"><span class="nav-number">11.2.</span> <span class="nav-text">7.2 docker 部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-number">11.3.</span> <span class="nav-text">7.3 集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-jar-%E5%8C%85%E9%83%A8%E7%BD%B2-1"><span class="nav-number">11.3.1.</span> <span class="nav-text">7.1 jar 包部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-docker-%E9%83%A8%E7%BD%B2-1"><span class="nav-number">11.4.</span> <span class="nav-text">7.2 docker 部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E5%B9%B6%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE%E9%95%9C%E5%83%8F"><span class="nav-number">11.5.</span> <span class="nav-text">打包并构建项目镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2-1"><span class="nav-number">11.6.</span> <span class="nav-text">7.3 集群部署</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="swimminghao"
      src="/images/lion.png">
  <p class="site-author-name" itemprop="name">swimminghao</p>
  <div class="site-description" itemprop="description">swimminghao的学习博客</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">134</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/swimminghao" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;swimminghao" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:swimminghao0@gmail.com" title="E-Mail → mailto:swimminghao0@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/swimminghao" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;swimminghao" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/yourname" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>


<!-- recent posts -->
    <div class="links-of-blogroll motion-element links-of-blogroll-block">
        <div class="links-of-blogroll-title recent-posts-title">
	    <i class="fa fa-history " aria-hidden="true"></i>
            近期文章
	</div>
	<ul class="links-of-blogroll-list recent-posts-list">
	        <li class="my-links-of-blogroll-item">
		    <a href="/posts/143a11e3/" title="zsh必备插件" target="">
		    zsh必备插件
		    </a>
		</li>
	        <li class="my-links-of-blogroll-item">
		    <a href="/posts/a7472f7b/" title="在校外时利用Easy Connect连接西工大校园内网（FTP、内网资源）简易教程" target="">
		    在校外时利用Easy Connect连接西工大校园内网（FTP、内网资源）简易教程
		    </a>
		</li>
	        <li class="my-links-of-blogroll-item">
		    <a href="/posts/b7702d4/" title="glance内存分析工具使用" target="">
		    glance内存分析工具使用
		    </a>
		</li>
	        <li class="my-links-of-blogroll-item">
		    <a href="/posts/6aa1f673/" title="命令行的艺术" target="">
		    命令行的艺术
		    </a>
		</li>
	        <li class="my-links-of-blogroll-item">
		    <a href="/posts/a70bb1ff/" title="手把手教你黑白群晖NAS安装破解版ROON音乐播放器1.6" target="">
		    手把手教你黑白群晖NAS安装破解版ROON音乐播放器1.6
		    </a>
		</li>
	</ul>
    </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/posts/55ff28b4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lion.png">
      <meta itemprop="name" content="swimminghao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="swimminghao's blog">
      <meta itemprop="description" content="swimminghao的学习博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="renren-fast开发文档3.0最新版 | swimminghao's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          renren-fast开发文档3.0最新版
        </h1>

        <div class="post-meta-container">

          

          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-16 10:05:00" itemprop="dateCreated datePublished" datetime="2022-03-16T10:05:00+08:00">2022-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-02 10:18:40" itemprop="dateModified" datetime="2022-06-02T10:18:40+08:00">2022-06-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/posts/55ff28b4/#waline-comments" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" id="/posts/55ff28b4/" data-xid="/posts/55ff28b4/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>91k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:23</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="renren-fast开发文档3-0最新版"><a href="#renren-fast开发文档3-0最新版" class="headerlink" title="renren-fast开发文档3.0最新版"></a>renren-fast开发文档3.0最新版</h1><h1 id="版权说明"><a href="#版权说明" class="headerlink" title="版权说明"></a>版权说明</h1><blockquote>
<p>本文档为付费文档，版权归人人开源（renren.io）所有，并保留一切权利，本文档及其描述的内容受有关法律的版权保护，对本文档以任何形式的非法复制、泄露或散布到网络提供下载，都将导致相应的法律责任。</p>
</blockquote>
<h1 id="免责声明"><a href="#免责声明" class="headerlink" title="免责声明"></a>免责声明</h1><blockquote>
<p>本文档仅提供阶段性信息，所含内容可根据项目的实际情况随时更新，以人人开源社区公告为准。如因文档使用不当造成的直接或间接损失，人人开源不承担任何责任。</p>
</blockquote>
<h1 id="文档更新"><a href="#文档更新" class="headerlink" title="文档更新"></a>文档更新</h1><blockquote>
<p>本文档由人人开源于 2019 年 03 月 01 日最后修订。</p>
</blockquote>
<h1 id="第-1-章-项目介绍"><a href="#第-1-章-项目介绍" class="headerlink" title="第 1 章 项目介绍"></a>第 1 章 项目介绍</h1><blockquote>
<p>人人权限系统是一套轻量级的权限系统，主要包括用户管理、角色管理、部门管理、菜单管理、定时任务、 参数管理、字典管理、文件上传、登录日志、操作日志、异常日志、文章管理、APP模块等功能。其中，还拥有多数据源、数据权限、国际化支持、Redis缓存动态开启与关闭、统一异常处理等技术特点。</p>
</blockquote>
<h2 id="1-1-项目描述"><a href="#1-1-项目描述" class="headerlink" title="1.1 项目描述"></a>1.1 项目描述</h2><h2 id="1-2-项目特点"><a href="#1-2-项目特点" class="headerlink" title="1.2 项目特点"></a>1.2 项目特点</h2><h2 id="1-3-数据交互"><a href="#1-3-数据交互" class="headerlink" title="1.3 数据交互"></a>1.3 数据交互</h2><h2 id="1-4-开发环境搭建"><a href="#1-4-开发环境搭建" class="headerlink" title="1.4 开发环境搭建"></a>1.4 开发环境搭建</h2><h2 id="1-5-获取帮助"><a href="#1-5-获取帮助" class="headerlink" title="1.5 获取帮助"></a>1.5 获取帮助</h2><h2 id="1-1-项目描述-1"><a href="#1-1-项目描述-1" class="headerlink" title="1.1 项目描述"></a>1.1 项目描述</h2><p>renren-fast是一套轻量级的权限系统，主要包括用户管理、角色管理、菜单管理、定时任务、文件上传、系 统日志、APP模块等功能。其中，还拥有多数据源、Redis缓存动态开启与关闭、统一异常处理等技术特 点。</p>
<h2 id="1-2-项目特点-1"><a href="#1-2-项目特点-1" class="headerlink" title="1.2 项目特点"></a>1.2 项目特点</h2><ul>
<li><a target="_blank" rel="noopener" href="https://gitee.com/renrenio/renren-fast">renren-fast</a>采用SpringBoot 2.1、MyBatis、Shiro框架，开发的一套权限系统，极低门槛，拿来即用。设<br>计之初，就非常注重安全性，为企业系统保驾护航，让一切都变得如此简单。</li>
<li>灵活的权限控制，可控制到页面或按钮，满足绝大部分的权限需求</li>
<li>完善的 XSS 防范及脚本过滤，彻底杜绝 XSS 攻击</li>
<li>支持MySQL、Oracle、SQL Server、PostgreSQL等主流数据库</li>
<li></li>
</ul>
<p>推荐使用阿里云服务器部署项目，免费领取阿里云优惠券，请点击<a target="_blank" rel="noopener" href="https://www.aliyun.com/minisite/goods?userCode=y93lfwbg&productCode=dmspre&utm_source=y93lfwbg">【免费领取】</a></p>
<h2 id="1-3-数据交互-1"><a href="#1-3-数据交互-1" class="headerlink" title="1.3 数据交互"></a>1.3 数据交互</h2><ul>
<li>一般情况下，web项目都是通过session进行认证，每次请求数据时，都会把jsessionid放在cookie中，以便与服务端保持会话</li>
<li>本项目是前后端分离的，通过token进行认证（登录时，生成唯一的token凭证），每次请求数据时，都会把token放在header中，服务端解析token，并确定用户身份及用户权限，数据通过json交互</li>
<li>数据交互流程，如下所示：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/7nZ7nU.png"></p>
<h2 id="1-4-开发环境搭建-1"><a href="#1-4-开发环境搭建-1" class="headerlink" title="1.4 开发环境搭建"></a>1.4 开发环境搭建</h2><h3 id="1-4-1-软件需求"><a href="#1-4-1-软件需求" class="headerlink" title="1.4.1 软件需求"></a>1.4.1 软件需求</h3><ul>
<li>JDK 1.8+</li>
<li>Maven 3.0+</li>
<li>MySQL 5.5+</li>
<li>Oracle 11g+</li>
<li>SQL Server 2012+</li>
<li>PostgreSQL 9.4+</li>
</ul>
<h3 id="1-4-2-下载源码"><a href="#1-4-2-下载源码" class="headerlink" title="1.4.2 下载源码"></a>1.4.2 下载源码</h3><ul>
<li>通过 git ，下载renren-fast源码，如下：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://gitee.com/renrenio/renren-fast.git</span><br></pre></td></tr></table></figure>

<h3 id="1-4-3-IDEA-开发工具"><a href="#1-4-3-IDEA-开发工具" class="headerlink" title="1.4.3 IDEA 开发工具"></a>1.4.3 IDEA 开发工具</h3><ul>
<li>IDEA打开项目， File -&gt; Open 如下图：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/EVCSoB.png"></p>
<h3 id="1-4-4-Eclipse-开发工具"><a href="#1-4-4-Eclipse-开发工具" class="headerlink" title="1.4.4 Eclipse 开发工具"></a>1.4.4 Eclipse 开发工具</h3><ul>
<li>Eclipse导入项目，如下图：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/C4IoHO.png"></p>
<h3 id="1-4-5-创建数据库"><a href="#1-4-5-创建数据库" class="headerlink" title="1.4.5 创建数据库"></a>1.4.5 创建数据库</h3><ul>
<li>创建数据库 renren_fast ，数据库编码为<code>UTF-8</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span></span><br><span class="line">DATABASE renren_fast <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br></pre></td></tr></table></figure>

<ul>
<li>执行 db&#x2F;mysql.sql 文件，初始化数据（默认支持MySQL）</li>
</ul>
<h3 id="1-4-6-修改配置文件"><a href="#1-4-6-修改配置文件" class="headerlink" title="1.4.6 修改配置文件"></a>1.4.6 修改配置文件</h3><ul>
<li>修改 <code>application-dev.yml</code> ，更新MySQL账号和密码</li>
<li>运行 io.renren.RenrenApplication.java 的 main 方法，则可启动项目</li>
<li>Swagger路径：<a target="_blank" rel="noopener" href="http://localhost:8080/renren-fast/swagger/index.html">http://localhost:8080/renren-fast/swagger/index.html</a></li>
<li>Swagger注解路径：<a target="_blank" rel="noopener" href="http://localhost:8080/renren-fast/swagger-ui.html">http://localhost:8080/renren-fast/swagger-ui.html</a></li>
</ul>
<h3 id="1-4-7-前端部署"><a href="#1-4-7-前端部署" class="headerlink" title="1.4.7 前端部署"></a>1.4.7 前端部署</h3><blockquote>
<p>renren-fast-vue基于vue、element-ui构建开发，实现renren-fast后台管理前端功能，提供一套更优的前端解决方案。 欢迎star或fork前端Git库，方便日后寻找，及二次开发</p>
</blockquote>
<ul>
<li>开发环境，需要安装node8.x最新版</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆项目</span></span><br><span class="line">git <span class="built_in">clone</span> https://gitee.com/renrenio/renren-fast-vue.git</span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">npm install --registry=https://registry.npm.taobao.org</span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<ul>
<li>生产环境，打包并把dist目录文件，部署到Nginx里</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#构建生产环境(默认)</span></span><br><span class="line">npm run build</span><br><span class="line"><span class="comment"># 构建测试环境</span></span><br><span class="line">npm run build --qa</span><br><span class="line"><span class="comment"># 构建验收环境</span></span><br><span class="line">npm run build --uat</span><br><span class="line"><span class="comment"># 构建生产环境</span></span><br><span class="line">npm run build --prod</span><br><span class="line"><span class="comment"># 安装Nginx，并配置Nginx</span></span><br><span class="line">server &#123;</span><br><span class="line">		listen 80;</span><br><span class="line">		server_name localhost;</span><br><span class="line">		location / &#123;</span><br><span class="line">				root E:\\renren-fast-vue;</span><br><span class="line">				index index.html index.htm;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 启动Nginx后，访问如下路径即可</span></span><br><span class="line">http://localhost</span><br></pre></td></tr></table></figure>

<ul>
<li>登录的账号密码：admin&#x2F;admin</li>
</ul>
<h2 id="1-5-获取帮助-1"><a href="#1-5-获取帮助-1" class="headerlink" title="1.5 获取帮助"></a>1.5 获取帮助</h2><ul>
<li><p>后端地址：<a target="_blank" rel="noopener" href="https://gitee.com/renrenio/renren-fast">https://gitee.com/renrenio/renren-fast</a></p>
</li>
<li><p>前端地址：<a target="_blank" rel="noopener" href="https://github.com/renrenio/renren-fast-vue">https://github.com/renrenio/renren-fast-vue</a></p>
</li>
<li><p>代码生成器：<a target="_blank" rel="noopener" href="https://gitee.com/renrenio/renren-generator">https://gitee.com/renrenio/renren-generator</a></p>
</li>
<li><p>官方社区：<a target="_blank" rel="noopener" href="https://www.renren.io/community">https://www.renren.io/community</a></p>
</li>
<li><p>如需寻求帮助、项目建议、技术讨论等，请移步到官方社区，我会在第一时间进行解答或回复 如需关注项目最新动态，请Watch、Star项目，同时也是对项目最好的支持</p>
</li>
</ul>
<h1 id="第-2-章-数据库支持"><a href="#第-2-章-数据库支持" class="headerlink" title="第 2 章 数据库支持"></a>第 2 章 数据库支持</h1><h2 id="2-1-MySQL-数据库支持"><a href="#2-1-MySQL-数据库支持" class="headerlink" title="2.1 MySQL 数据库支持"></a>2.1 MySQL 数据库支持</h2><h2 id="2-2-Oracle-数据库支持"><a href="#2-2-Oracle-数据库支持" class="headerlink" title="2.2 Oracle 数据库支持"></a>2.2 Oracle 数据库支持</h2><h2 id="2-3-SQL-Server-数据库支持"><a href="#2-3-SQL-Server-数据库支持" class="headerlink" title="2.3 SQL Server 数据库支持"></a>2.3 SQL Server 数据库支持</h2><h2 id="2-4-PostgreSQL-数据库支持"><a href="#2-4-PostgreSQL-数据库支持" class="headerlink" title="2.4 PostgreSQL 数据库支持"></a>2.4 PostgreSQL 数据库支持</h2><h2 id="2-1-MySQL-数据库支持-1"><a href="#2-1-MySQL-数据库支持-1" class="headerlink" title="2.1 MySQL 数据库支持"></a>2.1 MySQL 数据库支持</h2><ol>
<li>修改数据库配置信息，开发环境的配置文件在application-dev.yml，如下所示：</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/renren_fast?allowMultiQueries=true&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>执行db&#x2F;mysql.sql，创建表及初始化数据，再启动项目即可</li>
</ol>
<h2 id="2-2-Oracle-数据库支持-1"><a href="#2-2-Oracle-数据库支持-1" class="headerlink" title="2.2 Oracle 数据库支持"></a>2.2 Oracle 数据库支持</h2><ol>
<li>修改数据库配置信息，开发环境的配置文件在application-dev.yml，如下所示：</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">oracle.jdbc.OracleDriver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:oracle:thin:@192.168.10.10:1521:renren</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">renren_fast</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>执行db&#x2F;oracle.sql，创建表及初始化数据，再启动项目即可</li>
</ol>
<h2 id="2-3-SQL-Server-数据库支持-1"><a href="#2-3-SQL-Server-数据库支持-1" class="headerlink" title="2.3 SQL Server 数据库支持"></a>2.3 SQL Server 数据库支持</h2><ol>
<li>修改数据库配置信息，开发环境的配置文件在application-dev.yml，如下所示：</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.microsoft.sqlserver.jdbc.SQLServerDriver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">sa</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>执行db&#x2F;sqlserver.sql，创建表及初始化数据，再启动项目即可</li>
</ol>
<h2 id="2-4-PostgreSQL-数据库支持-1"><a href="#2-4-PostgreSQL-数据库支持-1" class="headerlink" title="2.4 PostgreSQL 数据库支持"></a>2.4 PostgreSQL 数据库支持</h2><ol>
<li>修改数据库配置信息，开发环境的配置文件在application-dev.yml，如下所示：</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.postgresql.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:postgresql://192.168.10.10:5432/renren_fast</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">renren</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改quartz配置信息，quartz配置文件 ScheduleConfig.java ，打开注释，如下所示：</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//PostgreSQL数据库，需要打开此注释</span></span><br><span class="line"><span class="string">prop.put(&quot;org.quartz.jobStore.driverDelegateClass&quot;,</span> <span class="string">&quot;org.quartz.impl.jdbcjobstore.PostgreSQLD</span></span><br><span class="line"><span class="string">elegate&quot;</span><span class="string">);</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>执行db&#x2F;postgresql.sql，创建表及初始化数据，再启动项目即可</li>
</ol>
<h1 id="第-3-章-多数据源支持"><a href="#第-3-章-多数据源支持" class="headerlink" title="第 3 章 多数据源支持"></a>第 3 章 多数据源支持</h1><h2 id="3-1-多数据源配置"><a href="#3-1-多数据源配置" class="headerlink" title="3.1 多数据源配置"></a>3.1 多数据源配置</h2><h2 id="3-2-多数据源使用"><a href="#3-2-多数据源使用" class="headerlink" title="3.2 多数据源使用"></a>3.2 多数据源使用</h2><h2 id="3-3-源码讲解"><a href="#3-3-源码讲解" class="headerlink" title="3.3 源码讲解"></a>3.3 源码讲解</h2><h2 id="3-1-多数据源配置-1"><a href="#3-1-多数据源配置-1" class="headerlink" title="3.1 多数据源配置"></a>3.1 多数据源配置</h2><blockquote>
<p>多数据源的应用场景，主要针对跨多个数据库实例的情况，如果是同实例中的多个数据库，则没必要使用多数据源。</p>
</blockquote>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#下面演示单实例，多数据库的使用情况</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> db.table;</span><br><span class="line"><span class="meta">#其中，db为数据库名，table为数据库表名</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置多数据源，如果是开发环境，则修改 application-dev.xml ，如下所示</li>
</ul>
<h2 id="多数据源的配置"><a href="#多数据源的配置" class="headerlink" title="多数据源的配置"></a>多数据源的配置</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dynamic:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">slave1:</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.microsoft.sqlserver.jdbc.SQLServerDriver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">sa</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">slave2:</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">org.postgresql.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:postgresql://192.168.10.10:5432/renren_fast</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">postgres</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<h2 id="3-2-多数据源使用-1"><a href="#3-2-多数据源使用-1" class="headerlink" title="3.2 多数据源使用"></a>3.2 多数据源使用</h2><blockquote>
<p>多数据源的使用，只需在Service类、方法上添加@DataSource(“”)注解即可，比如在类上添加了 @DataSource(“userDB”)注解，则表示该Service方法里的所有CURD，都会在 userDB 数据源里执行。</p>
</blockquote>
<ol>
<li>多数据源注解使用规则<ul>
<li>支持在Service类或方法上，添加多数据源的注解@DataSource</li>
<li>在Service类上添加了@DataSource注解，则该类下的所有方法，都会使用@DataSource标注的数据源</li>
<li>在Service类、方法上都添加了@DataSource注解，则方法上的注解会覆盖Service类上的注解</li>
</ul>
</li>
<li>编写DynamicDataSourceTestService.java，测试多数据源及事物</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.renren.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.renren.commons.dynamic.datasource.annotation.DataSource;</span><br><span class="line"><span class="keyword">import</span> io.renren.dao.SysUserDao;</span><br><span class="line"><span class="keyword">import</span> io.renren.entity.SysUserEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试多数据源</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="comment">//@DataSource(&quot;slave1&quot;) 多数据源全局配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceTestService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysUserDao sysUserDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">SysUserEntity</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SysUserEntity</span>();</span><br><span class="line">        user.setUserId(id);</span><br><span class="line">        user.setMobile(<span class="string">&quot;13500000000&quot;</span>);</span><br><span class="line">        sysUserDao.updateById(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@DataSource(&quot;slave1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUserBySlave1</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">SysUserEntity</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SysUserEntity</span>();</span><br><span class="line">        user.setUserId(id);</span><br><span class="line">        user.setMobile(<span class="string">&quot;13500000001&quot;</span>);</span><br><span class="line">        sysUserDao.updateById(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DataSource(&quot;slave2&quot;)</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUserBySlave2</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">SysUserEntity</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SysUserEntity</span>();</span><br><span class="line">        user.setUserId(id);</span><br><span class="line">        user.setMobile(<span class="string">&quot;13500000002&quot;</span>);</span><br><span class="line">        sysUserDao.updateById(user);</span><br><span class="line">        <span class="comment">//测试事物</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>运行测试类DynamicDataSourceTest.java，即可测试多数据源及事物是生效的</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.renren.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多数据源测试</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DynamicDataSourceTestService dynamicDataSourceTestService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">        dynamicDataSourceTestService.updateUser(id);</span><br><span class="line">        dynamicDataSourceTestService.updateUserBySlave1(id);</span><br><span class="line">        dynamicDataSourceTestService.updateUserBySlave2(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>其中， @DataSource(“slave1”) 、 @DataSource(“slave2”) 里的 slave1 、 slave2 值，是在application- dev.xml里配置的，如下所示：</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dynamic:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">slave1:</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.microsoft.sqlserver.jdbc.SQLServerDriver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:sqlserver://localhost:1433;DatabaseName=renren_security</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">sa</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">slave2:</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">org.postgresql.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:postgresql://localhost:5432/renren_security</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">renren</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<h2 id="3-3-源码讲解-1"><a href="#3-3-源码讲解-1" class="headerlink" title="3.3 源码讲解"></a>3.3 源码讲解</h2><ol>
<li>定义多数据源注解类@DataSource，使用多数据源时，只需在Service方法上添加@DataSource注解即可</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多数据源注解</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DataSource &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>定义读取多数据源配置文件的类，如下所示：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多数据源属性</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String driverClassName;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Druid默认参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">initialSize</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxActive</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">minIdle</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">maxWait</span> <span class="operator">=</span> <span class="number">60</span> * <span class="number">1000L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">timeBetweenEvictionRunsMillis</span> <span class="operator">=</span> <span class="number">60</span> * <span class="number">1000L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">minEvictableIdleTimeMillis</span> <span class="operator">=</span> <span class="number">1000L</span> * <span class="number">60L</span> * <span class="number">30L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">maxEvictableIdleTimeMillis</span> <span class="operator">=</span> <span class="number">1000L</span> * <span class="number">60L</span> * <span class="number">60L</span> * <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">validationQuery</span> <span class="operator">=</span> <span class="string">&quot;select 1&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">validationQueryTimeout</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">testOnBorrow</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">testOnReturn</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">testWhileIdle</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">poolPreparedStatements</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxOpenPreparedStatements</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">sharePreparedStatements</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">filters</span> <span class="operator">=</span> <span class="string">&quot;stat,wall&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDriverClassName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> driverClassName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDriverClassName</span><span class="params">(String driverClassName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.driverClassName = driverClassName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUrl</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getInitialSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> initialSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInitialSize</span><span class="params">(<span class="type">int</span> initialSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.initialSize = initialSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMaxActive</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> maxActive;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMaxActive</span><span class="params">(<span class="type">int</span> maxActive)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxActive = maxActive;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMinIdle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> minIdle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMinIdle</span><span class="params">(<span class="type">int</span> minIdle)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.minIdle = minIdle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getMaxWait</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> maxWait;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMaxWait</span><span class="params">(<span class="type">long</span> maxWait)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxWait = maxWait;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getTimeBetweenEvictionRunsMillis</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> timeBetweenEvictionRunsMillis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTimeBetweenEvictionRunsMillis</span><span class="params">(<span class="type">long</span> timeBetweenEvictionRunsMillis)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.timeBetweenEvictionRunsMillis =</span><br><span class="line">                timeBetweenEvictionRunsMillis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getMinEvictableIdleTimeMillis</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> minEvictableIdleTimeMillis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMinEvictableIdleTimeMillis</span><span class="params">(<span class="type">long</span> minEvictableIdleTimeMillis)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.minEvictableIdleTimeMillis =</span><br><span class="line">                minEvictableIdleTimeMillis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getMaxEvictableIdleTimeMillis</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> maxEvictableIdleTimeMillis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMaxEvictableIdleTimeMillis</span><span class="params">(<span class="type">long</span> maxEvictableIdleTimeMillis)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxEvictableIdleTimeMillis =</span><br><span class="line">                maxEvictableIdleTimeMillis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getValidationQuery</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> validationQuery;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValidationQuery</span><span class="params">(String validationQuery)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.validationQuery = validationQuery;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValidationQueryTimeout</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> validationQueryTimeout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValidationQueryTimeout</span><span class="params">(<span class="type">int</span> validationQueryTimeout)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.validationQueryTimeout =</span><br><span class="line">                validationQueryTimeout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isTestOnBorrow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> testOnBorrow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTestOnBorrow</span><span class="params">(<span class="type">boolean</span> testOnBorrow)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testOnBorrow = testOnBorrow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isTestOnReturn</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> testOnReturn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTestOnReturn</span><span class="params">(<span class="type">boolean</span> testOnReturn)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testOnReturn = testOnReturn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isTestWhileIdle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> testWhileIdle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTestWhileIdle</span><span class="params">(<span class="type">boolean</span> testWhileIdle)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testWhileIdle = testWhileIdle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isPoolPreparedStatements</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> poolPreparedStatements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPoolPreparedStatements</span><span class="params">(<span class="type">boolean</span> poolPreparedStatements)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolPreparedStatements =</span><br><span class="line">                poolPreparedStatements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMaxOpenPreparedStatements</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> maxOpenPreparedStatements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMaxOpenPreparedStatements</span><span class="params">(<span class="type">int</span> maxOpenPreparedStatements)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxOpenPreparedStatements =</span><br><span class="line">                maxOpenPreparedStatements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSharePreparedStatements</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sharePreparedStatements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSharePreparedStatements</span><span class="params">(<span class="type">boolean</span> sharePreparedStatements)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sharePreparedStatements =</span><br><span class="line">                sharePreparedStatements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFilters</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> filters;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFilters</span><span class="params">(String filters)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.filters = filters;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多数据源属性</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;dynamic&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, DataSourceProperties&gt; datasource = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, DataSourceProperties&gt; <span class="title function_">getDatasource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> datasource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDatasource</span><span class="params">(Map&lt;String, DataSourceProperties&gt; datasource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.datasource = datasource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>扩展Spring的AbstractRoutingDataSource抽象类，<br>AbstractRoutingDataSource中的抽象方法determineCurrentLookupKey是实现多数据源的核心，并对该方法进行Override，如下所示：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多数据源</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DynamicContextHolder.peek();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>数据源上下</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多数据源上下文</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicContextHolder</span> &#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Deque&lt;String&gt;&gt; CONTEXT_HOLDER = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Object <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得当前线程数据源</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据源名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">peek</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CONTEXT_HOLDER.get().peek();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置当前线程数据源</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource 数据源名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">push</span><span class="params">(String dataSource)</span> &#123;</span><br><span class="line">        CONTEXT_HOLDER.get().push(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空当前线程数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">poll</span><span class="params">()</span> &#123;</span><br><span class="line">        Deque&lt;String&gt; deque = CONTEXT_HOLDER.get();</span><br><span class="line">        deque.poll();</span><br><span class="line">        <span class="keyword">if</span> (deque.isEmpty()) &#123;</span><br><span class="line">            CONTEXT_HOLDER.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>配置多数据源，如下所示：</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> druidDataSource;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>@DataSource注解的切面处理类，动态切换的核心代码</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.druid.pool.DruidDataSource;</span><br><span class="line"><span class="keyword">import</span> io.renren.commons.dynamic.datasource.properties.DataSourceProperties;</span><br><span class="line"><span class="keyword">import</span> io.renren.commons.dynamic.datasource.properties.DynamicDataSourceProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置多数据源</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(DynamicDataSourceProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DynamicDataSourceProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.druid&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceProperties <span class="title function_">dataSourceProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceProperties</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//因为DynamicDataSource是继承与AbstractRoutingDataSource，而AbstractRoutingDataSource又是继</span></span><br><span class="line">    承于AbstractDataSource，AbstractDataSource实现了统一的DataSource接口，</span><br><span class="line">    所以DynamicDataSource也可</span><br><span class="line">            以当做DataSource使用</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DynamicDataSource <span class="title function_">dynamicDataSource</span><span class="params">(DataSourceProperties dataSourceProperties)</span> &#123;</span><br><span class="line">        <span class="type">DynamicDataSource</span> <span class="variable">dynamicDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DynamicDataSource</span>();</span><br><span class="line">        dynamicDataSource.setTargetDataSources(getDynamicDataSource());</span><br><span class="line">        <span class="comment">//默认数据源</span></span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">defaultDataSource</span> <span class="operator">=</span> DynamicDataSourceFactory.buildDruidDataSource(dat</span><br><span class="line">                aSourceProperties);</span><br><span class="line">        dynamicDataSource.setDefaultTargetDataSource(defaultDataSource);</span><br><span class="line">        <span class="keyword">return</span> dynamicDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Object, Object&gt; <span class="title function_">getDynamicDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;Object, Object&gt; targetDataSources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        properties.getDatasource().forEach((k, v) -&gt; &#123;</span><br><span class="line">            <span class="type">DruidDataSource</span> <span class="variable">druidDataSource</span> <span class="operator">=</span> DynamicDataSourceFactory.buildDruidDataSource(v</span><br><span class="line">            );</span><br><span class="line">            targetDataSources.put(k, druidDataSource);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> targetDataSources;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.druid.pool.DruidDataSource;</span><br><span class="line"><span class="keyword">import</span> io.renren.commons.dynamic.datasource.properties.DataSourceProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DruidDataSource</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DruidDataSource <span class="title function_">buildDruidDataSource</span><span class="params">(DataSourceProperties properties)</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">druidDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        druidDataSource.setDriverClassName(properties.getDriverClassName());</span><br><span class="line">        druidDataSource.setUrl(properties.getUrl());</span><br><span class="line">        druidDataSource.setUsername(properties.getUsername());</span><br><span class="line">        druidDataSource.setPassword(properties.getPassword());</span><br><span class="line">        druidDataSource.setInitialSize(properties.getInitialSize());</span><br><span class="line">        druidDataSource.setMaxActive(properties.getMaxActive());</span><br><span class="line">        druidDataSource.setMinIdle(properties.getMinIdle());</span><br><span class="line">        druidDataSource.setMaxWait(properties.getMaxWait());</span><br><span class="line">        druidDataSource.setTimeBetweenEvictionRunsMillis(properties.getTimeBetweenEvictionRun</span><br><span class="line">                <span class="title function_">sMillis</span><span class="params">()</span>);</span><br><span class="line">        druidDataSource.setMinEvictableIdleTimeMillis(properties.getMinEvictableIdleTimeMilli</span><br><span class="line">                <span class="title function_">s</span><span class="params">()</span>);</span><br><span class="line">        druidDataSource.setMaxEvictableIdleTimeMillis(properties.getMaxEvictableIdleTimeMilli</span><br><span class="line">                <span class="title function_">s</span><span class="params">()</span>);</span><br><span class="line">        druidDataSource.setValidationQuery(properties.getValidationQuery());</span><br><span class="line">        druidDataSource.setValidationQueryTimeout(properties.getValidationQueryTimeout());</span><br><span class="line">        druidDataSource.setTestOnBorrow(properties.isTestOnBorrow());</span><br><span class="line">        druidDataSource.setTestOnReturn(properties.isTestOnReturn());</span><br><span class="line">        druidDataSource.setPoolPreparedStatements(properties.isPoolPreparedStatements());</span><br><span class="line">        druidDataSource.setMaxOpenPreparedStatements(properties.getMaxOpenPreparedStatements(</span><br><span class="line">        ));</span><br><span class="line">        druidDataSource.setSharePreparedStatements(properties.isSharePreparedStatements());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            druidDataSource.setFilters(properties.getFilters());</span><br><span class="line">            druidDataSource.init();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> druidDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>@DataSource注解的切面处理类，动态切换的核心代码</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.renren.commons.dynamic.datasource.annotation.DataSource;</span><br><span class="line"><span class="keyword">import</span> io.renren.commons.dynamic.datasource.config.DynamicContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多数据源，切面处理类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAspect</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(io.renren.commons.dynamic.datasource.annotation.DataSource) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| @within(io.renren.commons.dynamic.datasource.annotation.DataSource)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dataSourcePointCut</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;dataSourcePointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) point.getSignature();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">targetClass</span> <span class="operator">=</span> point.getTarget().getClass();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> signature.getMethod();</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">targetDataSource</span> <span class="operator">=</span> (DataSource) targetClass.getAnnotation(DataSource.class);</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">methodDataSource</span> <span class="operator">=</span> method.getAnnotation(DataSource.class);</span><br><span class="line">        <span class="keyword">if</span> (targetDataSource != <span class="literal">null</span> || methodDataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">            String value;</span><br><span class="line">            <span class="keyword">if</span> (methodDataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">                value = methodDataSource.value();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                value = targetDataSource.value();</span><br><span class="line">            &#125;</span><br><span class="line">            DynamicContextHolder.push(value);</span><br><span class="line">            logger.debug(<span class="string">&quot;set datasource is &#123;&#125;&quot;</span>, value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> point.proceed();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            DynamicContextHolder.poll();</span><br><span class="line">            logger.debug(<span class="string">&quot;clean datasource&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="第-4-章-基础知识讲解"><a href="#第-4-章-基础知识讲解" class="headerlink" title="第 4 章 基础知识讲解"></a>第 4 章 基础知识讲解</h1><h2 id="4-1-Spring-MVC-使用"><a href="#4-1-Spring-MVC-使用" class="headerlink" title="4.1 Spring MVC 使用"></a>4.1 Spring MVC 使用</h2><h2 id="4-2-Swagger-使用"><a href="#4-2-Swagger-使用" class="headerlink" title="4.2 Swagger 使用"></a>4.2 Swagger 使用</h2><h2 id="4-3-Mybatis-plus-使用"><a href="#4-3-Mybatis-plus-使用" class="headerlink" title="4.3 Mybatis-plus 使用"></a>4.3 Mybatis-plus 使用</h2><h2 id="4-1-Spring-MVC-使用-1"><a href="#4-1-Spring-MVC-使用-1" class="headerlink" title="4.1 Spring MVC 使用"></a>4.1 Spring MVC 使用</h2><blockquote>
<p>对Spring MVC不太熟悉的，需要理解Spring MVC常用的注解，也方便日后排查问题，常用的注解如下所示：</p>
</blockquote>
<h3 id="4-1-1-Controller-注解"><a href="#4-1-1-Controller-注解" class="headerlink" title="4.1.1 @Controller 注解"></a>4.1.1 @Controller 注解</h3><p>@Controller注解表明了一个类是作为控制器的角色而存在的。Spring不要求你去继承任何控制器基类，也不要求你去实现Servlet的那套API。当然，如果你需要的话也可以去使用任何与Servlet相关的特性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-2-RequestMapping-注解"><a href="#4-1-2-RequestMapping-注解" class="headerlink" title="4.1.2 @RequestMapping 注解"></a>4.1.2 @RequestMapping 注解</h3><p>你可以使用@RequestMapping注解来将请求URL，如&#x2F;user等，映射到整个类上或某个特定的处理器方法上。<br>一般来说，类级别的注解负责将一个特定（或符合某种模式）的请求路径映射到一个控制器上，同时通过方法级别的注解来细化映射，即根据特定的HTTP请求方法（GET、POST方法等）、HTTP请求中是否携带特 定参数等条件，将请求映射到匹配的方法上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">user</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码没有指定请求必须是GET方法还是PUT&#x2F;POST或其他方法，@RequestMapping注解默认会映射所有 的HTTP请求方法。如果仅想接收某种请求方法，请在注解中指定之@RequestMapping(path &#x3D; “&#x2F;user”, method &#x3D; RequestMethod.GET)以缩小范围。</p>
<h3 id="4-1-3-PathVariable-注解"><a href="#4-1-3-PathVariable-注解" class="headerlink" title="4.1.3 @PathVariable 注解"></a>4.1.3 @PathVariable 注解</h3><p>在Spring MVC中你可以在方法参数上使用@PathVariable注解，将其与URI模板中的参数绑定起来，如下所 示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/user/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">userCenter</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> String userId,Model model)</span>&#123;</span><br><span class="line">        UserDTO user=userService.get(userId);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="keyword">return</span><span class="string">&quot;userCenter&quot;</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>URI模板”&#x2F;user&#x2F;{userId}”指定了一个变量名为userId。当控制器处理这个请求的时候，userId的值就会被URI模 板中对应部分的值所填充。比如说，如果请求的URI是&#x2F;userId&#x2F;1，此时变量userId的值就是 1 。</p>
<h3 id="4-1-4-GetMapping-注解"><a href="#4-1-4-GetMapping-注解" class="headerlink" title="4.1.4 @GetMapping 注解"></a>4.1.4 @GetMapping 注解</h3><p>@GetMapping是一个组合注解，是@RequestMapping(method &#x3D; RequestMethod.GET)的缩写。该注解将HTTP GET映射到特定的处理方法上。可以使用@GetMapping(“&#x2F;user”)来代替@RequestMapping(path&#x3D;”&#x2F;user”,method&#x3D;RequestMethod.GET)。还有@PostMapping、@PutMapping、 @DeleteMapping等同理。</p>
<h3 id="4-1-5-RequestBody-注解"><a href="#4-1-5-RequestBody-注解" class="headerlink" title="4.1.5 @RequestBody 注解"></a>4.1.5 @RequestBody 注解</h3><p>该注解用于读取Request请求的body部分数据，使用系统默认配置的HttpMessageConverter进行解析，然后把相应的数据绑定到要返回的对象上，再把HttpMessageConverter返回的对象数据绑定到Controller中方法的参数上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">user</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-6-ResponseBody-注解"><a href="#4-1-6-ResponseBody-注解" class="headerlink" title="4.1.6 @ResponseBody 注解"></a>4.1.6 @ResponseBody 注解</h3><p>该注解用于将Controller的方法返回的对象，通过适当的HttpMessageConverter转换为指定格式后，写入到Response对象的body数据区。比如获取JSON数据，加上@ResponseBody后，会直接返回JSON数据，而不会被解析为视图。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;userId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">info</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> String userId)</span> &#123;</span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> userService.get(userId);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-7-RestController-注解"><a href="#4-1-7-RestController-注解" class="headerlink" title="4.1.7 @RestController 注解"></a>4.1.7 @RestController 注解</h3><p>@RestController是一个组合注解，即@Controller + @ResponseBody的组合注解，请求完后，会返回JSON数据。</p>
<h2 id="4-2-Swagger-使用-1"><a href="#4-2-Swagger-使用-1" class="headerlink" title="4.2 Swagger 使用"></a>4.2 Swagger 使用</h2><blockquote>
<p>Swagger是一个根据Swagger注解，即可生成接口文档的服务。</p>
</blockquote>
<h3 id="4-2-1-搭建-Swagger-环境"><a href="#4-2-1-搭建-Swagger-环境" class="headerlink" title="4.2.1 搭建 Swagger 环境"></a>4.2.1 搭建 Swagger 环境</h3><ul>
<li>在pom.xml文件中添加swagger相关依赖，如下所示：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springfox-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springfox-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>编写Swagger的Configuration配置文件，如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiKey;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.google.common.collect.Lists.newArrayList;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">createRestApi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">//加了ApiOperation注解的类，才生成接口文档</span></span><br><span class="line">                .apis(RequestHandlerSelectors.withMethodAnnotation(ApiOperation.class))</span><br><span class="line">                <span class="comment">//io.renren.controller包下的类，才生成接口文档</span></span><br><span class="line">                <span class="comment">//.apis(RequestHandlerSelectors.basePackage(&quot;io.renren.controller&quot;))</span></span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build()</span><br><span class="line">                .directModelSubstitute(java.util.Date.class, String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApiInfo <span class="title function_">apiInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                .title(<span class="string">&quot;人人开源&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;人人开源接口文档&quot;</span>)</span><br><span class="line">                .termsOfServiceUrl(<span class="string">&quot;https://www.renren.io/community&quot;</span>)</span><br><span class="line">                .version(<span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-2-Swagger-常用注解"><a href="#4-2-2-Swagger-常用注解" class="headerlink" title="4.2.2 Swagger 常用注解"></a>4.2.2 Swagger 常用注解</h3><ul>
<li>@Api注解用在类上，说明该类的作用。可以标记一个Controller类做为swagger文档资源，如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Api(tags = &quot;用户管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>@ApiOperation注解用在方法上，说明该方法的作用，如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Api(tags = &quot;用户管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/list&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;列表&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;UserDTO&gt; <span class="title function_">list</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;UserDTO&gt; list = userService.list();</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>@ApiParam注解用在方法参数上，如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Api(tags = &quot;用户管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/list&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;列表&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List <span class="title function_">list</span><span class="params">(<span class="meta">@ApiParam(value = &quot;用户名&quot;, required = true)</span> String username)</span> &#123;</span><br><span class="line">        <span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> userService.list();</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>@ApiImplicitParams注解用在方法上，主要用于一组参数说明</p>
</li>
<li><p>@ApiImplicitParam注解用在@ApiImplicitParams注解中，指定一个请求参数的信息，如下所示：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;page&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;分页&quot;)</span></span><br><span class="line"><span class="meta">@ApiImplicitParams(&#123;</span></span><br><span class="line"><span class="meta">        @ApiImplicitParam(name = &quot;page&quot;, value = &quot;当前页码，从 1 开始&quot;, paramType = &quot;query&quot;, requ ired=true, dataType = &quot;int&quot;),</span></span><br><span class="line"><span class="meta">        @ApiImplicitParam(name = &quot;limit&quot;, value = &quot;每页显示记录数&quot;, paramType = &quot;query&quot;, requir ed=true, dataType = &quot;int&quot;),</span></span><br><span class="line"><span class="meta">        @ApiImplicitParam(name = &quot;order_field&quot;, value = &quot;排序字段&quot;, paramType = &quot;query&quot;, dataT ype=&quot;String&quot;),</span></span><br><span class="line"><span class="meta">        @ApiImplicitParam(name = &quot;order&quot;, value = &quot;排序方式，可选值(asc、desc)&quot;, paramType = &quot;q uery&quot;, dataType = &quot;String&quot;),</span></span><br><span class="line"><span class="meta">        @ApiImplicitParam(name = &quot;username&quot;, value = &quot;用户名&quot;, paramType = &quot;query&quot;, dataType = &quot;String&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageData&gt; <span class="title function_">page</span><span class="params">(<span class="meta">@ApiIgnore</span> <span class="meta">@RequestParam</span> Map&lt;String, Object&gt; par ams)</span>&#123;</span><br><span class="line">        PageData page=sysUserService.page(params);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;PageData&gt;().ok(page);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>@ApiIgnore注解，可用于类、方法或参数上，表示生成Swagger接口文档时，忽略类、方法或参数。</li>
</ul>
<h2 id="4-3-Mybatis-plus-使用-1"><a href="#4-3-Mybatis-plus-使用-1" class="headerlink" title="4.3 Mybatis-plus 使用"></a>4.3 Mybatis-plus 使用</h2><p>在项目的pom.xml里引入依赖，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatisplus.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在yml配置文件里，配置mybatis-plus，如下所示：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:/mapper/**/*.xml</span></span><br><span class="line">  <span class="comment">#实体扫描，多个package用逗号或者分号分隔</span></span><br><span class="line">  <span class="attr">typeAliasesPackage:</span> <span class="string">io.renren.modules.*.entity</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="comment">#数据库相关配置</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">    <span class="comment">#主键类型 AUTO:&quot;数据库ID自增&quot;, INPUT:&quot;用户输入ID&quot;, ID_WORKER:&quot;全局唯一ID (数字类型唯一ID)&quot;</span></span><br><span class="line">    <span class="string">,</span> <span class="string">UUID:&quot;全局唯一ID</span> <span class="string">UUID&quot;;</span></span><br><span class="line">    <span class="attr">id-type:</span> <span class="string">AUTO</span></span><br><span class="line">    <span class="comment">#字段策略 IGNORED:&quot;忽略判断&quot;,NOT_NULL:&quot;非 NULL 判断&quot;),NOT_EMPTY:&quot;非空判断&quot;</span></span><br><span class="line">    <span class="attr">field-strategy:</span> <span class="string">NOT_NULL</span></span><br><span class="line">    <span class="comment">#驼峰下划线转换</span></span><br><span class="line">    <span class="attr">column-underline:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">logic-delete-value:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">logic-not-delete-value:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">banner:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment">#原生配置</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache-enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">call-setters-on-nulls:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">jdbc-type-for-null:</span> <span class="string">&#x27;null&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="第-5-章-项目实战"><a href="#第-5-章-项目实战" class="headerlink" title="第 5 章 项目实战"></a>第 5 章 项目实战</h1><h2 id="5-1-需求说明"><a href="#5-1-需求说明" class="headerlink" title="5.1 需求说明"></a>5.1 需求说明</h2><h2 id="5-2-代码生成器"><a href="#5-2-代码生成器" class="headerlink" title="5.2 代码生成器"></a>5.2 代码生成器</h2><h2 id="5-1-需求说明-1"><a href="#5-1-需求说明-1" class="headerlink" title="5.1 需求说明"></a>5.1 需求说明</h2><blockquote>
<p>我们来完成一个商品的列表、添加、修改、删除功能，熟悉如何快速开发自己的业务功能模块。</p>
</blockquote>
<ul>
<li>我们先建一个商品表tb_goods，表结构如下所示：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_goods`</span><br><span class="line">(</span><br><span class="line">    `goods_id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;商品ID&#x27;</span>,</span><br><span class="line">    `name`     <span class="type">varchar</span>(<span class="number">50</span>) COMMENT <span class="string">&#x27;商品名&#x27;</span>,</span><br><span class="line">    `intro`    <span class="type">varchar</span>(<span class="number">500</span>) COMMENT <span class="string">&#x27;介绍&#x27;</span>,</span><br><span class="line">    `price`    <span class="type">decimal</span>(<span class="number">10</span>, <span class="number">2</span>) COMMENT <span class="string">&#x27;价格&#x27;</span>,</span><br><span class="line">    `num`      <span class="type">int</span> COMMENT <span class="string">&#x27;数量&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`goods_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;商品管理&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="5-1-代码生成器"><a href="#5-1-代码生成器" class="headerlink" title="5.1 代码生成器"></a>5.1 代码生成器</h2><ul>
<li>使用代码生成器前，我们先来看下代码生成器的配置，看看那些是可配置的，打开renren-generator模块 的配置文件generator.properties，如下所示：</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#代码生成器，配置信息</span></span><br><span class="line"><span class="attr">mainPath</span>=<span class="string">io.renren</span></span><br><span class="line"><span class="comment">#包名</span></span><br><span class="line"><span class="attr">package</span>=<span class="string">io.renren.modules</span></span><br><span class="line"><span class="attr">moduleName</span>=<span class="string">generator</span></span><br><span class="line"><span class="comment">#作者</span></span><br><span class="line"><span class="attr">author</span>=<span class="string">Mark</span></span><br><span class="line"><span class="comment">#Email</span></span><br><span class="line"><span class="attr">email</span>=<span class="string">sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment">#表前缀(类名不会包含表前缀)</span></span><br><span class="line"><span class="attr">tablePrefix</span>=<span class="string">tb_</span></span><br><span class="line"><span class="comment">#类型转换，配置信息</span></span><br><span class="line"><span class="attr">tinyint</span>=<span class="string">Integer</span></span><br><span class="line"><span class="attr">smallint</span>=<span class="string">Integer</span></span><br><span class="line"><span class="attr">mediumint</span>=<span class="string">Integer</span></span><br><span class="line"><span class="attr">int</span>=<span class="string">Integer</span></span><br><span class="line"><span class="attr">integer</span>=<span class="string">Integer</span></span><br><span class="line"><span class="attr">bigint</span>=<span class="string">Long</span></span><br><span class="line"><span class="attr">float</span>=<span class="string">Float</span></span><br><span class="line"><span class="attr">double</span>=<span class="string">Double</span></span><br><span class="line"><span class="attr">decimal</span>=<span class="string">BigDecimal</span></span><br><span class="line"><span class="attr">bit</span>=<span class="string">Boolean</span></span><br><span class="line"><span class="attr">char</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">varchar</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">tinytext</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">text</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">mediumtext</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">longtext</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">date</span>=<span class="string">Date</span></span><br><span class="line"><span class="attr">datetime</span>=<span class="string">Date</span></span><br><span class="line"><span class="attr">timestamp</span>=<span class="string">Date</span></span><br><span class="line"><span class="attr">NUMBER</span>=<span class="string">Integer</span></span><br><span class="line"><span class="attr">INT</span>=<span class="string">Integer</span></span><br><span class="line"><span class="attr">INTEGER</span>=<span class="string">Integer</span></span><br><span class="line"><span class="attr">BINARY_INTEGER</span>=<span class="string">Integer</span></span><br><span class="line"><span class="attr">LONG</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">FLOAT</span>=<span class="string">Float</span></span><br><span class="line"><span class="attr">BINARY_FLOAT</span>=<span class="string">Float</span></span><br><span class="line"><span class="attr">DOUBLE</span>=<span class="string">Double</span></span><br><span class="line"><span class="attr">BINARY_DOUBLE</span>=<span class="string">Double</span></span><br><span class="line"><span class="attr">DECIMAL</span>=<span class="string">BigDecimal</span></span><br><span class="line"><span class="attr">CHAR</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">VARCHAR</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">VARCHAR2</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">NVARCHAR</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">NVARCHAR2</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">CLOB</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">BLOB</span>=<span class="string">String</span></span><br><span class="line"><span class="attr">DATE</span>=<span class="string">Date</span></span><br><span class="line"><span class="attr">DATETIME</span>=<span class="string">Date</span></span><br><span class="line"><span class="attr">TIMESTAMP</span>=<span class="string">Date</span></span><br><span class="line"><span class="attr">TIMESTAMP(6)</span>=<span class="string">Date</span></span><br><span class="line"><span class="attr">int8</span>=<span class="string">Long</span></span><br><span class="line"><span class="attr">int4</span>=<span class="string">Integer</span></span><br><span class="line"><span class="attr">int2</span>=<span class="string">Integer</span></span><br><span class="line"><span class="attr">numeric</span>=<span class="string">BigDecimal</span></span><br></pre></td></tr></table></figure>

<p>上面的配置文件，可以配置包名、作者信息、表前缀、模块名称、类型转换等信息。其中，类型转换是指， MySQL中的类型与JavaBean中的类型，是怎么一个对应关系。如果有缺少的类型，可自行在generator.properties文件中补充。</p>
<ul>
<li>再看看renren-generator模块的application.yml配置文件，我们只要修改数据库名、账号、密码，就可以 了。其中，数据库名是指待生成的表，所在的数据库。</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="comment"># mysql</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="comment">#MySQL配置</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/renren_fast?useUnicode=true&amp;characterEncoding=UTF-8&amp;useS</span></span><br><span class="line">    <span class="string">SL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">renren</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="comment">#oracle配置</span></span><br><span class="line">    <span class="comment"># driverClassName: oracle.jdbc.OracleDriver</span></span><br><span class="line">    <span class="comment"># url: jdbc:oracle:thin:@47.100.206.162:1521:xe</span></span><br><span class="line">    <span class="comment"># username: renren</span></span><br><span class="line">    <span class="comment"># password: 123456</span></span><br><span class="line">    <span class="comment">#SQLServer配置</span></span><br><span class="line">    <span class="comment"># driverClassName: com.microsoft.sqlserver.jdbc.SQLServerDriver</span></span><br><span class="line">    <span class="comment"># url: jdbc:sqlserver://192.168.10.10:1433;DatabaseName=renren_fast</span></span><br><span class="line">    <span class="comment"># username: sa</span></span><br><span class="line">    <span class="comment"># password: 123456</span></span><br><span class="line">    <span class="comment">#PostgreSQL配置</span></span><br><span class="line">    <span class="comment"># driverClassName: org.postgresql.Driver</span></span><br><span class="line">    <span class="comment"># url: jdbc:postgresql://192.168.10.10:5432/renren_fast</span></span><br><span class="line">    <span class="comment"># username: postgres</span></span><br><span class="line">    <span class="comment"># password: 123456</span></span><br><span class="line">    <span class="attr">jackson:</span></span><br><span class="line">      <span class="attr">time-zone:</span> <span class="string">GMT+8</span> <span class="attr">date-format: yyyy-MM-dd HH:mm:ss resources:</span></span><br><span class="line">      <span class="attr">static-locations:</span> <span class="string">classpath:/static/,classpath:/views/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapperLocations:</span> <span class="string">classpath:mapper/**/*.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pagehelper:</span></span><br><span class="line">  <span class="attr">reasonable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">supportMethodsArguments:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">params:</span> <span class="string">count=countSql</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定数据库，可选值有【mysql、oracle、sqlserver、postgresql】 </span></span><br><span class="line"><span class="attr">renren:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">mysql</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>在数据库renren_fast中，执行建表语句，创建tb_goods表，再启动renren-generator项目(运行 RenrenApplication.java的main方法即可)，如下所示：</p>
</li>
<li><p>在浏览器里输入项目地址(<a href="http://localhost)，如下所示：">http://localhost)，如下所示：</a></p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/HWqMVn.png"></p>
<ul>
<li>我们只需勾选tb_goods，点击【生成代码】按钮，则可生成相应代码，如下所示：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/Pli3sp.png"></p>
<ul>
<li>我们来看下生成的代码结构，如下所示：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/BhpLFE.png"></p>
<ul>
<li>生成好代码后，我们只需在数据库renren_fast中，执行goods_menu.sql语句，这个SQL是生成菜单的， SQL语句如下所示：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># <span class="comment">-- 菜单SQL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;商品管理&#x27;</span>, <span class="string">&#x27;generator/goods&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;6&#x27;</span>);</span><br><span class="line"></span><br><span class="line"># <span class="comment">-- 按钮父菜单ID</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> <span class="variable">@parentId</span> <span class="operator">=</span> @<span class="variable">@identity</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 菜单对应按钮SQL INSERT INTO `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`)</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@parentId</span>,</span><br><span class="line">       <span class="string">&#x27;查看&#x27;</span>,</span><br><span class="line">       <span class="keyword">null</span>,</span><br><span class="line">       <span class="string">&#x27;generator:goods:list,generator:goods:info&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">       <span class="keyword">null</span>,</span><br><span class="line">       <span class="string">&#x27;6</span></span><br><span class="line"><span class="string">      &#x27;</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@parentId</span>, <span class="string">&#x27;新增&#x27;</span>, <span class="keyword">null</span>, <span class="string">&#x27;generator:goods:save&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="keyword">null</span>, <span class="string">&#x27;6&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `sys_menu` (`parent_id`, `name`, `url`, `perms`, `type`, `icon`, `order_num`)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@parentId</span>, <span class="string">&#x27;修改&#x27;</span>, <span class="keyword">null</span>, <span class="string">&#x27;generator:goods:update&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="keyword">null</span>, <span class="string">&#x27;6&#x27;</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `sys_menu` ( `parent_id`, `name`</span><br><span class="line">                       , `url`, `perms`, `type`, `icon`, `order_num`)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@parentId</span>, <span class="string">&#x27;删除&#x27;</span>, <span class="keyword">null</span>, <span class="string">&#x27;generator:goods:delete&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="keyword">null</span>, <span class="string">&#x27;6&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来，再把刚生成的后端代码，添加到项目renren-fast里，前端vue代码，添加到前端项目renren-fast- vue里，在启动renren-fast项目，如下所示：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/hHJj2Z.png"></p>
<ul>
<li>现在，我们就可以新增、修改、删除等操作</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/iAj5t1.png"></p>
<h1 id="第-6-章-后端源码分析"><a href="#第-6-章-后端源码分析" class="headerlink" title="第 6 章 后端源码分析"></a>第 6 章 后端源码分析</h1><h2 id="6-1-前后端分离"><a href="#6-1-前后端分离" class="headerlink" title="6.1 前后端分离"></a>6.1 前后端分离</h2><h2 id="6-2-权限设计思路"><a href="#6-2-权限设计思路" class="headerlink" title="6.2 权限设计思路"></a>6.2 权限设计思路</h2><h2 id="6-3-XSS-脚本过滤"><a href="#6-3-XSS-脚本过滤" class="headerlink" title="6.3 XSS 脚本过滤"></a>6.3 XSS 脚本过滤</h2><h2 id="6-4-SQL-注入"><a href="#6-4-SQL-注入" class="headerlink" title="6.4 SQL 注入"></a>6.4 SQL 注入</h2><h2 id="6-5-Redis-缓存"><a href="#6-5-Redis-缓存" class="headerlink" title="6.5 Redis 缓存"></a>6.5 Redis 缓存</h2><h2 id="6-6-异常处理机制"><a href="#6-6-异常处理机制" class="headerlink" title="6.6 异常处理机制"></a>6.6 异常处理机制</h2><h2 id="6-7-后端效验机制"><a href="#6-7-后端效验机制" class="headerlink" title="6.7 后端效验机制"></a>6.7 后端效验机制</h2><h2 id="6-8-系统日志"><a href="#6-8-系统日志" class="headerlink" title="6.8 系统日志"></a>6.8 系统日志</h2><h2 id="6-9-添加菜单"><a href="#6-9-添加菜单" class="headerlink" title="6.9 添加菜单"></a>6.9 添加菜单</h2><h2 id="6-10-添加角色"><a href="#6-10-添加角色" class="headerlink" title="6.10 添加角色"></a>6.10 添加角色</h2><h2 id="6-11-添加管理员"><a href="#6-11-添加管理员" class="headerlink" title="6.11 添加管理员"></a>6.11 添加管理员</h2><h2 id="6-12-定时任务模块"><a href="#6-12-定时任务模块" class="headerlink" title="6.12 定时任务模块"></a>6.12 定时任务模块</h2><h2 id="6-13-云存储模块"><a href="#6-13-云存储模块" class="headerlink" title="6.13 云存储模块"></a>6.13 云存储模块</h2><h2 id="6-14-APP-模块"><a href="#6-14-APP-模块" class="headerlink" title="6.14 APP 模块"></a>6.14 APP 模块</h2><h2 id="6-1-前后端分离-1"><a href="#6-1-前后端分离-1" class="headerlink" title="6.1 前后端分离"></a>6.1 前后端分离</h2><blockquote>
<p>要实现前后端分离，需要考虑以下 2 个问题：</p>
<pre><code>1. 项目不再基于session了，如何知道访问者是谁？
1. 如何确认访问者的权限？
3. 前后端分离
</code></pre>
</blockquote>
<ul>
<li>一般都是通过token实现，本项目也是一样；用户登录时，生成token及token过期时间，token与用户是一一对应关系，调用接口的时候，把token放到header或请求参数中，服务端就知道是谁在调用接口，登录如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;captcha.jpg&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">captcha</span><span class="params">(HttpServletResponse response, String uuid)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    response.setHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-store, no-cache&quot;</span>);</span><br><span class="line">    response.setContentType(<span class="string">&quot;image/jpeg&quot;</span>);</span><br><span class="line">    <span class="comment">//获取图片验证码</span></span><br><span class="line">    <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> sysCaptchaService.getCaptcha(uuid);</span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">    ImageIO.write(image, <span class="string">&quot;jpg&quot;</span>, out);</span><br><span class="line">    IOUtils.closeQuietly(out);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/sys/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> SysLoginForm form)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">captcha</span> <span class="operator">=</span> sysCaptchaService.validate(form.getUuid(), form.getCaptcha());</span><br><span class="line">    <span class="keyword">if</span> (!captcha) &#123;</span><br><span class="line">        <span class="keyword">return</span> R.error(<span class="string">&quot;验证码不正确&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户信息</span></span><br><span class="line">    <span class="type">SysUserEntity</span> <span class="variable">user</span> <span class="operator">=</span> sysUserService.queryByUserName(form.getUsername());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//账号不存在、密码错误</span></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || !user.getPassword().equals(<span class="keyword">new</span> <span class="title class_">Sha256Hash</span>(form.getPassword(), user.get</span><br><span class="line">            <span class="title function_">Salt</span><span class="params">()</span>).toHex())) &#123;</span><br><span class="line">        <span class="keyword">return</span> R.error(<span class="string">&quot;账号或密码不正确&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//账号锁定</span></span><br><span class="line">    <span class="keyword">if</span> (user.getStatus() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> R.error(<span class="string">&quot;账号已被锁定,请联系管理员&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//生成token，并保存到数据库</span></span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> sysUserTokenService.createToken(user.getUserId());</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//生产token</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">createToken</span><span class="params">(<span class="type">long</span> userId)</span> &#123;</span><br><span class="line">    <span class="comment">//生成一个token，可以是uuid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> TokenGenerator.generateValue();</span><br><span class="line">    <span class="comment">//当前时间</span></span><br><span class="line">    <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="comment">//过期时间</span></span><br><span class="line">    <span class="type">Date</span> <span class="variable">expireTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(now.getTime() + EXPIRE * <span class="number">1000</span>);</span><br><span class="line">    <span class="comment">//判断是否生成过token</span></span><br><span class="line">    <span class="type">SysUserTokenEntity</span> <span class="variable">tokenEntity</span> <span class="operator">=</span> queryByUserId(userId);</span><br><span class="line">    <span class="keyword">if</span> (tokenEntity == <span class="literal">null</span>) &#123;</span><br><span class="line">        tokenEntity = <span class="keyword">new</span> <span class="title class_">SysUserTokenEntity</span>();</span><br><span class="line">        tokenEntity.setUserId(userId);</span><br><span class="line">        tokenEntity.setToken(token);</span><br><span class="line">        tokenEntity.setUpdateTime(now);</span><br><span class="line">        tokenEntity.setExpireTime(expireTime);</span><br><span class="line">        <span class="comment">//保存token</span></span><br><span class="line">        save(tokenEntity);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        tokenEntity.setToken(token);</span><br><span class="line">        tokenEntity.setUpdateTime(now);</span><br><span class="line">        tokenEntity.setExpireTime(expireTime);</span><br><span class="line">        <span class="comment">//更新token</span></span><br><span class="line">        update(tokenEntity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> R.ok().put(<span class="string">&quot;token&quot;</span>, token).put(<span class="string">&quot;expire&quot;</span>, EXPIRE);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，下面的这行代码，是加盐操作；可能有人不理解为何要加盐，其目的是防止被拖库后，黑客轻易的 （通过密码库对比），就能拿到你的密码</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="constructor">Sha256Hash(<span class="params">password</span>, <span class="params">user</span>.<span class="params">getSalt</span>()</span>).<span class="keyword">to</span><span class="constructor">Hex()</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>调用接口时，接受传过来的token后，如何保证token有效及用户权限呢？其实，shiro提供了 AuthenticatingFilter抽象类，继承AuthenticatingFilter抽象类即可。</li>
</ul>
<p>步骤 1 ，所有请求全部拒绝访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤 2 ，拒绝访问的请求，会调用onAccessDenied方法，onAccessDenied方法先获取token，再调用 executeLogin方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//获取请求token，如果token不存在，直接返回 401</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> getRequestToken((HttpServletRequest) request);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(token)) &#123;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">httpResponse</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(R.error(HttpStatus.SC_UNAUTHORIZED, <span class="string">&quot;invalid token&quot;</span>));</span><br><span class="line">        httpResponse.getWriter().print(json);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> executeLogin(request, response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取请求的token</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getRequestToken</span><span class="params">(HttpServletRequest httpRequest)</span> &#123;</span><br><span class="line">    <span class="comment">//从header中获取token</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> httpRequest.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">    <span class="comment">//如果header中不存在token，则从参数中获取token</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(token)) &#123;</span><br><span class="line">        token = httpRequest.getParameter(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤 3 ，阅读AuthenticatingFilter抽象类中executeLogin方法，我们发现调用了 subject.login(token) ，这是shiro的登录方法，且需要token参数，我们自定义OAuth2Token类，只要实现AuthenticationToken接口，就可以了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AuthenticatingFilter类中的方法</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">executeLogin</span><span class="params">(ServletRequest request,ServletResponse response)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    AuthenticationToken token=createToken(request,response);</span><br><span class="line">    <span class="keyword">if</span>(token==<span class="literal">null</span>)&#123;</span><br><span class="line">        String msg=<span class="string">&quot;createToken method implementation returned null. A valid non-null A</span></span><br><span class="line"><span class="string">        uthenticationToken&quot;</span> +</span><br><span class="line">        <span class="string">&quot;must be created in order to execute a login attempt.&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        Subject subject=getSubject(request,response);</span><br><span class="line">        subject.login(token);</span><br><span class="line">        <span class="keyword">return</span> onLoginSuccess(token,subject,request,response);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(AuthenticationException e)&#123;</span><br><span class="line">        <span class="keyword">return</span> onLoginFailure(token,e,request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">//subject.login(token)中的token对象，需要实现AuthenticationToken接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuth2Token</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationToken</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OAuth2Token</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.token = token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPrincipal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getCredentials</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤 4 ，定义OAuth2Realm类，并继承AuthorizingRealm抽象类，调用 subject.login(token) 时，则会调用doGetAuthenticationInfo方法，进行登录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * authentication身份认证(登录时调用)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 9. 前面被authc拦截后，需要认证，SecurityBean会调用这里进行认证</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">accessToken</span> <span class="operator">=</span> (String) token.getPrincipal();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据accessToken，查询用户信息</span></span><br><span class="line">    <span class="type">SysUserTokenEntity</span> <span class="variable">tokenEntity</span> <span class="operator">=</span> shiroService.queryByToken(accessToken);</span><br><span class="line">    <span class="comment">//token失效</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(tokenEntity == <span class="literal">null</span> || tokenEntity.getExpireTime().getTime() &lt; System.currentTimeMillis())&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncorrectCredentialsException</span>(<span class="string">&quot;token失效，请重新登录&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 9.1. token生效才能登录</span></span><br><span class="line">    <span class="comment">//查询用户信息</span></span><br><span class="line">    <span class="type">SysUserEntity</span> <span class="variable">user</span> <span class="operator">=</span> shiroService.queryUser(tokenEntity.getUserId());</span><br><span class="line">    <span class="comment">//账号锁定</span></span><br><span class="line">    <span class="keyword">if</span>(user.getStatus() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LockedAccountException</span>(<span class="string">&quot;账号已被锁定,请联系管理员&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">SimpleAuthenticationInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(user, accessToken, getName());</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤 5 ，登录失败后，则调用onLoginFailure，进行失败处理，整个流程结束</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onLoginFailure</span><span class="params">(AuthenticationToken token, AuthenticationException e, ServletRequest request, ServletResponse response)</span> &#123;</span><br><span class="line">    <span class="type">HttpServletResponse</span> <span class="variable">httpResponse</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">    httpResponse.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//处理登录失败的异常</span></span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">throwable</span> <span class="operator">=</span> e.getCause() == <span class="literal">null</span> ? e : e.getCause();</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> R.error(HttpStatus.SC_UNAUTHORIZED, throwable.getMessage());</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(r);</span><br><span class="line">        httpResponse.getWriter().print(json);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤 6 ，登录成功后，则调用doGetAuthorizationInfo方法，查询用户的权限，再调用具体的接口，整个流程 结束</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * authorization授权(验证权限时调用)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 10. 前面被roles拦截后，需要授权才能登录，SecurityManager需要调用这里进行权限查询</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> &#123;</span><br><span class="line">    <span class="type">SysUserEntity</span> <span class="variable">user</span> <span class="operator">=</span> (SysUserEntity)principals.getPrimaryPrincipal();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> user.getUserId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户权限列表</span></span><br><span class="line">    Set&lt;String&gt; permsSet = shiroService.getUserPermissions(userId);</span><br><span class="line"></span><br><span class="line">    <span class="type">SimpleAuthorizationInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line">    info.setStringPermissions(permsSet);</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-2-权限设计思路-1"><a href="#6-2-权限设计思路-1" class="headerlink" title="6.2 权限设计思路"></a>6.2 权限设计思路</h2><p>权限相关的表结构，如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/np520W.png"></p>
<ol>
<li>sys_user[用户]表，保存用户相关数据，通过sys_user_role[用户与角色关联]表，与sys_role[角色]表关联；sys_menu[菜单]表通过sys_role_menu[菜单与角色关联]表，与sys_role[角色]表关联</li>
<li>sys_menu表，保存菜单相关数据，并在perms字段里，保存了shiro的权限标识，也就是说，拥有此菜单，就拥有perms字段里的所有权限，比如，某用户拥有的菜单权限标识 sys:user:info ，就可以访问下面的方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/info/&#123;userId&#125;&quot;)</span></span><br><span class="line"><span class="meta">@RequiresPermissions(&quot;sys:user:info&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">info</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> Long userId)</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在shiro配置代码里，配置为 anon 的，表示不经过shiro处理，配置为 oauth2 的，表示经过 OAuth2Filter 处理，前后端分离的接口，都会交给 OAuth2Filter处理，这样就保证，没有权限的请求，拒绝访问</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Shiro配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  Shiro自带的过滤器，可以在这里配置拦截页面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;shiroFilter&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shiroFilter</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 初始化一个ShiroFilter工程类</span></span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        <span class="comment">// 2. 我们知道Shiro是通过SecurityManager来管理整个认证和授权流程的，这个SecurityManager可以在下面初始化</span></span><br><span class="line">        shiroFilter.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自定义Oauth2Filter过滤器</span></span><br><span class="line">        Map&lt;String, Filter&gt; filters = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        filters.put(<span class="string">&quot;oauth2&quot;</span>, <span class="keyword">new</span> <span class="title class_">OAuth2Filter</span>());</span><br><span class="line">        shiroFilter.setFilters(filters);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 上面我们讲过，有的页面不需登录任何人可以直接访问，有的需要登录才能访问，有的不仅要登录还需要相关权限才能访问</span></span><br><span class="line">        Map&lt;String, String&gt; filterMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. Shiro过滤器常用的有如下几种</span></span><br><span class="line">        <span class="comment">// 4.1. anon 任何人都能访问，如登录页面</span></span><br><span class="line">        <span class="comment">// 4.2. authc 需要登录才能访问，如系统内的全体通知页面</span></span><br><span class="line">        <span class="comment">// 4.3. roles 需要相应的角色才能访问</span></span><br><span class="line">        filterMap.put(<span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/druid/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/app/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/sys/login&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/swagger/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/v2/api-docs&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/swagger-ui.html&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/swagger-resources/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/captcha.jpg&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/aaa.txt&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;oauth2&quot;</span>);</span><br><span class="line">        <span class="comment">// 5. 让ShiroFilter按这个规则拦截</span></span><br><span class="line">        shiroFilter.setFilterChainDefinitionMap(filterMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 用户没登录被拦截后，当然需要调转到登录页了，这里配置登录页</span></span><br><span class="line">        <span class="comment">//shiroFilterFactoryBean.setLoginUrl(&quot;/api/user/login&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> shiroFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;securityManager&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SecurityManager <span class="title function_">securityManager</span><span class="params">(OAuth2Realm oAuth2Realm)</span> &#123;</span><br><span class="line">        <span class="comment">// 7. 新建一个SecurityManager供ShiroFilterFactoryBean使用</span></span><br><span class="line">        <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">        <span class="comment">// 8. SecurityManager既然管理认证等信息，那他就需要一个类来帮他查数据库吧。这就是Realm类</span></span><br><span class="line">        securityManager.setRealm(oAuth2Realm);</span><br><span class="line">        securityManager.setRememberMeManager(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> LifecycleBeanPostProcessor <span class="title function_">lifecycleBeanPostProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LifecycleBeanPostProcessor</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title function_">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">AuthorizationAttributeSourceAdvisor</span> <span class="variable">advisor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizationAttributeSourceAdvisor</span>();</span><br><span class="line">        advisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> advisor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-3-XSS-脚本过滤-1"><a href="#6-3-XSS-脚本过滤-1" class="headerlink" title="6.3 XSS 脚本过滤"></a>6.3 XSS 脚本过滤</h2><blockquote>
<p>XSS跨站脚本攻击的基本原理和SQL注入攻击类似，都是利用系统执行了未经过滤的危险代码，不同点 在于XSS是一种基于网页脚本的注入方式，也就是将脚本攻击载荷写入网页执行以达到对网页客户端访问用户攻击的目的，属于客户端攻击。程序员往往不太关心安全这块，这就给有心之人，提供了机会，本系统针对XSS攻击，提供了过滤功能，可以有效防止XSS攻击，代码如下：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XssFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig config)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">XssHttpServletRequestWrapper</span> <span class="variable">xssRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XssHttpServletRequestWrapper</span>(</span><br><span class="line">                (HttpServletRequest) request);</span><br><span class="line">        chain.doFilter(xssRequest, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean <span class="title function_">xssFilterRegistration</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">FilterRegistrationBean</span> <span class="variable">registration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>();</span><br><span class="line">        registration.setDispatcherTypes(DispatcherType.REQUEST);</span><br><span class="line">        registration.setFilter(<span class="keyword">new</span> <span class="title class_">XssFilter</span>());</span><br><span class="line">        registration.addUrlPatterns(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        registration.setName(<span class="string">&quot;xssFilter&quot;</span>);</span><br><span class="line">        registration.setOrder(Integer.MAX_VALUE);</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>自定义XssFilter过滤器，用来过滤所有请求，具体过滤还是在XssHttpServletRequestWrapper里实现的， 如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XssHttpServletRequestWrapper</span> <span class="keyword">extends</span> <span class="title class_">HttpServletRequestWrapper</span> &#123;</span><br><span class="line">    <span class="comment">//没被包装过的HttpServletRequest（特殊场景，需要自己过滤）</span></span><br><span class="line">    HttpServletRequest orgRequest;</span><br><span class="line">    <span class="comment">//html过滤</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">HTMLFilter</span> <span class="variable">htmlFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTMLFilter</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">XssHttpServletRequestWrapper</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(request);</span><br><span class="line">        orgRequest = request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServletInputStream <span class="title function_">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"><span class="comment">//非json类型，直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (!MediaType.APPLICATION_JSON_VALUE.equalsIgnoreCase(<span class="built_in">super</span>.getHeader(HttpHeaders.CON</span><br><span class="line">                TENT_TYPE))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.getInputStream();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//为空，直接返回</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> IOUtils.toString(<span class="built_in">super</span>.getInputStream(), <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.getInputStream();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//xss过滤</span></span><br><span class="line">        json = xssEncode(json);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(json.getBytes(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServletInputStream</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isFinished</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isReady</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setReadListener</span><span class="params">(ReadListener readListener)</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="keyword">return</span> bis.read();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getParameter</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">super</span>.getParameter(xssEncode(name));</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(value)) &#123;</span><br><span class="line">            value = xssEncode(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getParameterValues(String name) &#123;</span><br><span class="line">        String[] parameters = <span class="built_in">super</span>.getParameterValues(name);</span><br><span class="line">        <span class="keyword">if</span> (parameters == <span class="literal">null</span> || parameters.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameters.length; i++) &#123;</span><br><span class="line">            parameters[i] = xssEncode(parameters[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> parameters;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String[]&gt; getParameterMap() &#123;</span><br><span class="line">        Map&lt;String, String[]&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;String, String[]&gt; parameters = <span class="built_in">super</span>.getParameterMap();</span><br><span class="line">        <span class="keyword">for</span> (String key : parameters.keySet()) &#123;</span><br><span class="line">            String[] values = parameters.get(key);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">                values[i] = xssEncode(values[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            map.put(key, values);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getHeader</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">super</span>.getHeader(xssEncode(name));</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(value)) &#123;</span><br><span class="line">            value = xssEncode(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">xssEncode</span><span class="params">(String input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> htmlFilter.filter(input);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取最原始的request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> HttpServletRequest <span class="title function_">getOrgRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> orgRequest;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取最原始的request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HttpServletRequest <span class="title function_">getOrgRequest</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> XssHttpServletRequestWrapper) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((XssHttpServletRequestWrapper) request).getOrgRequest();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> request;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要处理富文本数据，可以通过 XssHttpServletRequestWrapper.getOrgRequest(request) ，拿到原始 的 request 对象后，再自行处理富文本数据，如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> R <span class="title function_">data</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">        HttpServletRequest orgRequest=XssHttpServletRequestWrapper.getOrgRequest(request);</span><br><span class="line">        String content=orgRequest.getParameter(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">        <span class="comment">//富文本数据</span></span><br><span class="line">        System.out.println(content);</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-4-SQL-注入-1"><a href="#6-4-SQL-注入-1" class="headerlink" title="6.4 SQL 注入"></a>6.4 SQL 注入</h2><blockquote>
<p>本系统使用的是Mybatis，如果使用${}拼接SQL，则存在SQL注入风险，可以对参数进行过滤，避免 SQL注入，如下:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLFilter</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SQL注入过滤</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str 待验证的字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sqlInject</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(str)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//去掉&#x27;|&quot;|;|\字符</span></span><br><span class="line">        str = StringUtils.replace(str, <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        str = StringUtils.replace(str, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        str = StringUtils.replace(str, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        str = StringUtils.replace(str, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">//转换成小写\</span></span><br><span class="line">        str = str.toLowerCase();</span><br><span class="line">        <span class="comment">//非法字符</span></span><br><span class="line">        String[] keywords = &#123;<span class="string">&quot;master&quot;</span>, <span class="string">&quot;truncate&quot;</span>, <span class="string">&quot;insert&quot;</span>, <span class="string">&quot;select&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;declare&quot;</span>, <span class="string">&quot;alter&quot;</span>, <span class="string">&quot;drop&quot;</span>&#125;;</span><br><span class="line">        <span class="comment">//判断是否包含非法字符</span></span><br><span class="line">        <span class="keyword">for</span> (String keyword : keywords) &#123;</span><br><span class="line">            <span class="keyword">if</span> (str.indexOf(keyword) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;包含非法字符&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>像查询列表，涉及排序问题，排序字段是从前台传过来的，则存在SQL注入风险，需经如下处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Query</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> IPage&lt;T&gt; <span class="title function_">getPage</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getPage(params, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IPage&lt;T&gt; <span class="title function_">getPage</span><span class="params">(Map&lt;String, Object&gt; params, String defaultOrderField, <span class="type">boolean</span> isAsc)</span> &#123;</span><br><span class="line">        <span class="comment">//分页参数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">curPage</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">limit</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">if</span> (params.get(Constant.PAGE) != <span class="literal">null</span>) &#123;</span><br><span class="line">            curPage = Long.parseLong((String) params.get(Constant.PAGE));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (params.get(Constant.LIMIT) != <span class="literal">null</span>) &#123;</span><br><span class="line">            limit = Long.parseLong((String) params.get(Constant.LIMIT));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分页对象</span></span><br><span class="line">        Page&lt;T&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(curPage, limit);</span><br><span class="line">        <span class="comment">//分页参数 </span></span><br><span class="line">        params.put(Constant.PAGE, page);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//排序字段 </span></span><br><span class="line">        <span class="comment">//防止SQL注入（因为sidx、order是通过拼接SQL实现排序的，会有SQL注入风险）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderField</span> <span class="operator">=</span> SQLFilter.sqlInject((String) params.get(Constant.ORDER_FIELD));</span><br><span class="line">        <span class="type">String</span> <span class="variable">order</span> <span class="operator">=</span> (String) params.get(Constant.ORDER);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//前端字段排序</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(orderField) &amp;&amp; StringUtils.isNotEmpty(order)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Constant.ASC.equalsIgnoreCase(order)) &#123;</span><br><span class="line">                <span class="keyword">return</span> page.setAsc(orderField);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> page.setDesc(orderField);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//默认排序</span></span><br><span class="line">        <span class="keyword">if</span> (isAsc) &#123;</span><br><span class="line">            page.setAsc(defaultOrderField);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            page.setDesc(defaultOrderField);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> page;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-5-Redis-缓存-1"><a href="#6-5-Redis-缓存-1" class="headerlink" title="6.5 Redis 缓存"></a>6.5 Redis 缓存</h2><blockquote>
<p>缓存大家都很熟悉，但能否灵活运用，就不一定了。一般设计缓存架构时，我们需要考虑如下几个问 题：</p>
</blockquote>
<ol>
<li><p>查询数据的时候，尽量减少DB查询，DB主要负责写数据</p>
</li>
<li><p>尽量不使用 LEFT JOIN 等关联查询，缓存命中率不高，还浪费内存</p>
</li>
<li><p>多使用单表查询，缓存命中率最高</p>
</li>
<li><p>数据库 insert 、 update 、 delete 时，同步更新缓存数据</p>
</li>
<li><p>合理运用Redis数据结构，也许有质的飞跃</p>
</li>
<li><p>对于访问量不大的项目，使用缓存只会增加项目的复杂度</p>
</li>
</ol>
<p>本系统采用Redis作为缓存，并可配置是否开启redis缓存，主要还是通过Spring AOP实现的，配置如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">redis:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">password:</span> <span class="comment"># 密码（默认为空）</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">6000ms</span> <span class="comment"># 连接超时时长（毫秒）</span></span><br><span class="line">  <span class="attr">jedis:</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">1000</span> <span class="comment"># 连接池最大连接数（使用负值表示没有限制）</span></span><br><span class="line">      <span class="attr">max-wait:</span> <span class="string">-1ms</span> <span class="comment"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span></span><br><span class="line">      <span class="attr">max-idle:</span> <span class="number">10</span> <span class="comment"># 连接池中的最大空闲连接</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">5</span> <span class="comment"># 连接池中的最小空闲连接</span></span><br><span class="line"><span class="attr">renren:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">  	<span class="attr">open:</span> <span class="literal">false</span> <span class="comment">#是否开启redis缓存 true开启 false关闭</span></span><br></pre></td></tr></table></figure>

<p>本项目中，使用Redis服务的代码，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysConfigServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SysConfigService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysConfigDao sysConfigDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysConfigRedis sysConfigRedis;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(SysConfigEntity config)</span> &#123;</span><br><span class="line">        sysConfigDao.save(config);</span><br><span class="line">        sysConfigRedis.saveOrUpdate(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(SysConfigEntity config)</span> &#123;</span><br><span class="line">        sysConfigDao.update(config);</span><br><span class="line">        sysConfigRedis.saveOrUpdate(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateValueByKey</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        sysConfigDao.updateValueByKey(key, value);</span><br><span class="line">        sysConfigRedis.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteBatch</span><span class="params">(Long[] ids)</span> &#123;</span><br><span class="line">        sysConfigDao.deleteBatch(ids);</span><br><span class="line">        <span class="keyword">for</span> (Long id : ids) &#123;</span><br><span class="line">            <span class="type">SysConfigEntity</span> <span class="variable">config</span> <span class="operator">=</span> queryObject(id);</span><br><span class="line">            sysConfigRedis.delete(config.getKey());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysConfigRedis</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtils redisUtils;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveOrUpdate</span><span class="params">(SysConfigEntity config)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (config == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKeys.getSysConfigKey(config.getKey());</span><br><span class="line">        redisUtils.set(key, config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(String configKey)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKeys.getSysConfigKey(configKey);</span><br><span class="line">        redisUtils.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SysConfigEntity <span class="title function_">get</span><span class="params">(String configKey)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKeys.getSysConfigKey(configKey);</span><br><span class="line">        <span class="keyword">return</span> redisUtils.get(key, SysConfigEntity.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisUtils</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ValueOperations&lt;String, String&gt; valueOperations;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HashOperations&lt;String, String, Object&gt; hashOperations;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListOperations&lt;String, Object&gt; listOperations;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetOperations&lt;String, Object&gt; setOperations;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ZSetOperations&lt;String, Object&gt; zSetOperations;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认过期时长，单位：秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">DEFAULT_EXPIRE</span> <span class="operator">=</span> <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不设置过期时长</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">NOT_EXPIRE</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Gson</span> <span class="variable">gson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, <span class="type">long</span> expire)</span> &#123;</span><br><span class="line">        valueOperations.set(key, toJson(value));</span><br><span class="line">        <span class="keyword">if</span> (expire != NOT_EXPIRE) &#123;</span><br><span class="line">            redisTemplate.expire(key, expire, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        set(key, value, DEFAULT_EXPIRE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">get</span><span class="params">(String key, Class&lt;T&gt; clazz, <span class="type">long</span> expire)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> valueOperations.get(key);</span><br><span class="line">        <span class="keyword">if</span> (expire != NOT_EXPIRE) &#123;</span><br><span class="line">            redisTemplate.expire(key, expire, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">return</span> <span class="variable">value</span> <span class="operator">=</span>= <span class="literal">null</span> ? <span class="literal">null</span> : fromJson(value, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">get</span><span class="params">(String key, Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> get(key, clazz, NOT_EXPIRE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String key, <span class="type">long</span> expire)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> valueOperations.get(key);</span><br><span class="line">        <span class="keyword">if</span> (expire != NOT_EXPIRE) &#123;</span><br><span class="line">            redisTemplate.expire(key, expire, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> get(key, NOT_EXPIRE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        redisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Object转成JSON数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">toJson</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Integer || object <span class="keyword">instanceof</span> Long || object <span class="keyword">instanceof</span> Float ||</span><br><span class="line">                object <span class="keyword">instanceof</span> Double || object <span class="keyword">instanceof</span> Boolean || object <span class="keyword">instanceof</span> St</span><br><span class="line">                ring) &#123;</span><br><span class="line">            <span class="keyword">return</span> String.valueOf(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> gson.toJson(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JSON数据，转成Object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; T <span class="title function_">fromJson</span><span class="params">(String json, Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> gson.fromJson(json, clazz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大家可能会有疑问，认为这个项目必须要配置Redis缓存，不然会报错，因为有操作Redis的代码，其实不 然，通过Spring AOP，我们可以控制，是否真的使用Redis，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisAspect</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(getClass());</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否开启redis缓存 true开启 false关闭</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;renren.redis.open: false&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> open;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* io.renren.common.utils.RedisUtils.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (open) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result = point.proceed();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;redis error&quot;</span>, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;Redis服务异常&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-6-异常处理机制-1"><a href="#6-6-异常处理机制-1" class="headerlink" title="6.6 异常处理机制"></a>6.6 异常处理机制</h2><blockquote>
<p>本项目通过RRException异常类，抛出自定义异常，RRException继承RuntimeException，不能继承 Exception，如果继承Exception，则Spring事务不会回滚。</p>
</blockquote>
<p>RRException代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RRException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RRException</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg);</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RRException</span><span class="params">(String msg, Throwable e)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg, e);</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RRException</span><span class="params">(String msg, <span class="type">int</span> code)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg);</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RRException</span><span class="params">(String msg, <span class="type">int</span> code, Throwable e)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg, e);</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMsg</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(<span class="type">int</span> code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如何处理抛出的异常呢，我们定义了RRExceptionHandler类，并加上注解@RestControllerAdvice，就可以处理所有抛出的异常，并返回JSON数据。@RestControllerAdvice是由@ControllerAdvice、@ResponseBody注解组合而来的，可以查找@ControllerAdvice相关的资料，理解@ControllerAdvice注解 的使用。</p>
</blockquote>
<p>RRExceptionHandler代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RRExceptionHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理自定义异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(RRException.class)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">handleRRException</span><span class="params">(RRException e)</span> &#123;</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">        r.put(<span class="string">&quot;code&quot;</span>, e.getCode());</span><br><span class="line">        r.put(<span class="string">&quot;msg&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(DuplicateKeyException.class)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">handleDuplicateKeyException</span><span class="params">(DuplicateKeyException e)</span> &#123;</span><br><span class="line">        logger.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> R.error(<span class="string">&quot;数据库中已存在该记录&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(AuthorizationException.class)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">handleAuthorizationException</span><span class="params">(AuthorizationException e)</span> &#123;</span><br><span class="line">        logger.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> R.error(<span class="string">&quot;没有权限，请联系管理员授权&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">handleException</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line">        logger.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> R.error();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-7-后端效验机制-1"><a href="#6-7-后端效验机制-1" class="headerlink" title="6.7 后端效验机制"></a>6.7 后端效验机制</h2><blockquote>
<p>本项目，后端效验使用的是Hibernate Validator校验框架，且自定义ValidatorUtils工具类，用来效验数 据。</p>
</blockquote>
<p>Hibernate Validator官方文档： <a target="_blank" rel="noopener" href="http://docs.jboss.org/hibernate/validator/5.4/reference/en-US/html_single/">http://docs.jboss.org/hibernate/validator/5.4/reference/en-US/html_single/</a><br>ValidatorUtils代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidatorUtils</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Validator validator;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        validator = Validation.buildDefaultValidatorFactory().getValidator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object 待校验对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> groups 待校验的组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RRException 校验不通过，则报RRException异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">validateEntity</span><span class="params">(Object object, Class&lt;?&gt;... groups)</span> <span class="keyword">throws</span> RRException &#123;</span><br><span class="line">        Set&lt;ConstraintViolation&lt;Object&gt;&gt; constraintViolations = validator.validate(object, groups);</span><br><span class="line">        <span class="keyword">if</span> (!constraintViolations.isEmpty()) &#123;</span><br><span class="line">            ConstraintViolation&lt;Object&gt; constraint = (ConstraintViolation&lt;Object&gt;) constraintV</span><br><span class="line">            iolations.iterator().next();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(constraint.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用案例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/sys/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysUserController</span> <span class="keyword">extends</span> <span class="title class_">AbstractController</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SysLog(&quot;保存用户&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;sys:user:save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> SysUserEntity user)</span> &#123;</span><br><span class="line"><span class="comment">//保存用户时，效验SysUserEntity里，带有AddGroup注解的属性</span></span><br><span class="line">        ValidatorUtils.validateEntity(user, AddGroup.class);</span><br><span class="line">        user.setCreateUserId(getUserId());</span><br><span class="line">        sysUserService.save(user);</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SysLog(&quot;修改用户&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;sys:user:update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> SysUserEntity user)</span> &#123;</span><br><span class="line"><span class="comment">//修改用户时，效验SysUserEntity里，带有UpdateGroup注解的属性</span></span><br><span class="line">        ValidatorUtils.validateEntity(user, UpdateGroup.class);</span><br><span class="line">        user.setCreateUserId(getUserId());</span><br><span class="line">        sysUserService.update(user);</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysUserEntity</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;用户名不能为空&quot;, groups = &#123;AddGroup.class, UpdateGroup.class&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;密码不能为空&quot;, groups = AddGroup.class)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 盐</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String salt;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮箱</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;邮箱不能为空&quot;, groups = &#123;AddGroup.class, UpdateGroup.class&#125;)</span></span><br><span class="line">    <span class="meta">@Email(message = &quot;邮箱格式不正确&quot;, groups = &#123;AddGroup.class, UpdateGroup.class&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 手机号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态</span></span><br><span class="line"><span class="comment">     0：禁用</span></span><br><span class="line"><span class="comment">     1：正常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 角色ID列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; roleIdList;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建者ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long createUserId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过分析上面的代码，我们来理解Hibernate Validator校验框架的使用。 其中，username属性，表示保存或修改用户时，都会效验username属性；而password属性，表示只有保存用户时，才会效验password属性，也就是说，修改用户时，password可以不填写，允许为空。</p>
<p>如果不指定属性的groups，则默认属于javax.validation.groups.Default.class分组，可以通过ValidatorUtils.validateEntity(user)进行效验。</p>
<h2 id="6-8-系统日志-1"><a href="#6-8-系统日志-1" class="headerlink" title="6.8 系统日志"></a>6.8 系统日志</h2><p>系统日志是通过Spring AOP实现的，我们自定义了注解 @SysLog ，且只能在方法上使用，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SysLog &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是自定义注解 @SysLog 的使用方式，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/sys/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysUserController</span> <span class="keyword">extends</span> <span class="title class_">AbstractController</span> &#123;</span><br><span class="line">    <span class="meta">@SysLog(&quot;保存用户&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;sys:user:save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> SysUserEntity user)</span> &#123;</span><br><span class="line">        ValidatorUtils.validateEntity(user, AddGroup.class);</span><br><span class="line">        user.setCreateUserId(getUserId());</span><br><span class="line">        sysUserService.save(user);</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以发现，只需要在保存日志的请求方法上，加上 @SysLog 注解，就可以把日志保存到数据库里了。 具体是在哪里把数据保存到数据库里的呢，我们定义了 SysLogAspect 处理类，就是来干这事的，如下所 示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统日志，切面处理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysLogAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysLogService sysLogService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(io.renren.common.annotation.SysLog)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logPointCut</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;logPointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">beginTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="comment">//执行方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> point.proceed();</span><br><span class="line"><span class="comment">//执行时长(毫秒)</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> System.currentTimeMillis() - beginTime;</span><br><span class="line"><span class="comment">//保存日志</span></span><br><span class="line">        saveSysLog(point, time);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveSysLog</span><span class="params">(ProceedingJoinPoint joinPoint, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> signature.getMethod();</span><br><span class="line">        <span class="type">SysLogEntity</span> <span class="variable">sysLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SysLogEntity</span>();</span><br><span class="line">        <span class="type">SysLog</span> <span class="variable">syslog</span> <span class="operator">=</span> method.getAnnotation(SysLog.class);</span><br><span class="line">        <span class="keyword">if</span> (syslog != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">//注解上的描述</span></span><br><span class="line">            sysLog.setOperation(syslog.value());</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//请求的方法名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> joinPoint.getTarget().getClass().getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> signature.getName();</span><br><span class="line">        sysLog.setMethod(className + <span class="string">&quot;.&quot;</span> + methodName + <span class="string">&quot;()&quot;</span>);</span><br><span class="line"><span class="comment">//请求的参数</span></span><br><span class="line">        Object[] args = joinPoint.getArgs();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">params</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(args[<span class="number">0</span>]);</span><br><span class="line">            sysLog.setParams(params);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//获取request</span></span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> HttpContextUtils.getHttpServletRequest();</span><br><span class="line"><span class="comment">//设置IP地址</span></span><br><span class="line">        sysLog.setIp(IPUtils.getIpAddr(request));</span><br><span class="line"><span class="comment">//用户名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> ((SysUserEntity) SecurityUtils.getSubject().getPrincipal()).getUser</span><br><span class="line">        <span class="title function_">name</span><span class="params">()</span>;</span><br><span class="line">        sysLog.setUsername(username);</span><br><span class="line">        sysLog.setTime(time);</span><br><span class="line">        sysLog.setCreateDate(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line"><span class="comment">//保存系统日志</span></span><br><span class="line">        sysLogService.save(sysLog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SysLogAspect 类定义了一个切入点，请求 @SysLog 注解的方法时，会进入 around方法，把系统日志保存到数据库中。</p>
<h2 id="6-9-添加菜单-1"><a href="#6-9-添加菜单-1" class="headerlink" title="6.9 添加菜单"></a>6.9 添加菜单</h2><blockquote>
<p>菜单管理，主要是对【目录、菜单、按钮】进行动态的新增、修改、删除等操作，方便开发者管理菜单。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/G7kxHE.png"></p>
<p>上图是拿现有的菜单进行讲解。其中，授权标识与shiro中的注解@RequiresPermissions，定义的授权标识是 一一对应的，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/sys/config&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysConfigController</span> <span class="keyword">extends</span> <span class="title class_">AbstractController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;sys:config:list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">list</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/info/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;sys:config:info&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">info</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;sys:config:save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> SysConfigEntity config)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;sys:config:update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> SysConfigEntity config)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/delete&quot;)</span></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;sys:config:delete&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestBody</span> Long[] ids)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-10-添加角色-1"><a href="#6-10-添加角色-1" class="headerlink" title="6.10 添加角色"></a>6.10 添加角色</h2><blockquote>
<p>管理员权限是通过角色进行管理的，给管理员分配权限时，要先创建好角色。</p>
</blockquote>
<p>下面创建了一个【开发角色】，如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/qsBkIQ.png"></p>
<h2 id="6-11-添加管理员-1"><a href="#6-11-添加管理员-1" class="headerlink" title="6.11 添加管理员"></a>6.11 添加管理员</h2><blockquote>
<p>本系统默认就创建了admin账号，无需分配任何角色，就拥有最高权限。 一个管理员是可以拥有多个角 色的。</p>
</blockquote>
<p>下面创建一个【zhangsan】的管理员账号，并属于【开发角色】，如下所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/xyolW8.png"></p>
<h2 id="6-12-定时任务模块-1"><a href="#6-12-定时任务模块-1" class="headerlink" title="6.12 定时任务模块"></a>6.12 定时任务模块</h2><blockquote>
<p>本系统使用开源框架Quartz，实现的定时任务，已实现分布式定时任务，可部署多台服务器，不重复执行，以及动态增加、修改、删除、暂停、恢复、立即执行定时任务。 Quartz自带了各数据库的SQL脚本，如果想更改成其他数据库，可参考Quartz相应的SQL脚本。</p>
</blockquote>
<h3 id="6-12-1-新增定时任务"><a href="#6-12-1-新增定时任务" class="headerlink" title="6.12.1 新增定时任务"></a>6.12.1 新增定时任务</h3><p>新增一个定时任务，其实很简单，只要定义一个普通的Spring Bean即可，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;testTask&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestTask</span> <span class="keyword">implements</span> <span class="title class_">ITask</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String params)</span> &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;TestTask定时任务正在执行，参数为：&#123;&#125;&quot;</span>, params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何让Quartz，定时执行testTask里的方法呢？只需要在管理后台，新增一个定时任务即可，如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/j1UF4l.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/9d5CTr.png"></p>
<p>刚才配置的定时任务，每隔 30 分钟，就会调用TestTask的test方法了，是不是很简单啊。</p>
<h4 id="6-12-2-源码分析"><a href="#6-12-2-源码分析" class="headerlink" title="6.12.2 源码分析"></a>6.12.2 源码分析</h4><p>Quartz提供了相关的API，我们可以调用API，对Quartz进行增加、修改、删除、暂停、恢复、立即执行等。 本系统中， ScheduleUtils 类就是对Quartz API进行的封装，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduleUtils</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">JOB_NAME</span> <span class="operator">=</span> <span class="string">&quot;TASK_&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取触发器key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TriggerKey <span class="title function_">getTriggerKey</span><span class="params">(Long jobId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TriggerKey.triggerKey(JOB_NAME + jobId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取jobKey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JobKey <span class="title function_">getJobKey</span><span class="params">(Long jobId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JobKey.jobKey(JOB_NAME + jobId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取表达式触发器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CronTrigger <span class="title function_">getCronTrigger</span><span class="params">(Scheduler scheduler, Long jobId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (CronTrigger) scheduler.getTrigger(getTriggerKey(jobId));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;getCronTrigger异常，请检查qrtz开头的表，是否有脏数据&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建定时任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createScheduleJob</span><span class="params">(Scheduler scheduler, ScheduleJobEntity scheduleJob)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//构建job信息</span></span><br><span class="line">            <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> JobBuilder.newJob(ScheduleJob.class).withIdentity(getJobKey</span><br><span class="line">                    (scheduleJob.getJobId())).build();</span><br><span class="line"><span class="comment">//表达式调度构建器</span></span><br><span class="line">            <span class="type">CronScheduleBuilder</span> <span class="variable">scheduleBuilder</span> <span class="operator">=</span> CronScheduleBuilder.cronSchedule(scheduleJo</span><br><span class="line">                    b.getCronExpression())</span><br><span class="line">                    .withMisfireHandlingInstructionDoNothing();</span><br><span class="line"><span class="comment">//按新的cronExpression表达式构建一个新的trigger</span></span><br><span class="line">            <span class="type">CronTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> TriggerBuilder.newTrigger().withIdentity(getTriggerKey(sche</span><br><span class="line">                    duleJob.getJobId())).</span><br><span class="line">                    withSchedule(scheduleBuilder).build();</span><br><span class="line"><span class="comment">//放入参数，运行时的方法可以获取</span></span><br><span class="line">            jobDetail.getJobDataMap().put(ScheduleJobEntity.JOB_PARAM_KEY, <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(</span><br><span class="line">                    scheduleJob));</span><br><span class="line">            scheduler.scheduleJob(jobDetail, trigger);</span><br><span class="line"><span class="comment">//暂停任务</span></span><br><span class="line">            <span class="keyword">if</span> (scheduleJob.getStatus() == ScheduleStatus.PAUSE.getValue()) &#123;</span><br><span class="line">                pauseJob(scheduler, scheduleJob.getJobId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;创建定时任务失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新定时任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">updateScheduleJob</span><span class="params">(Scheduler scheduler, ScheduleJobEntity scheduleJob)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">TriggerKey</span> <span class="variable">triggerKey</span> <span class="operator">=</span> getTriggerKey(scheduleJob.getJobId());</span><br><span class="line"><span class="comment">//表达式调度构建器</span></span><br><span class="line">            <span class="type">CronScheduleBuilder</span> <span class="variable">scheduleBuilder</span> <span class="operator">=</span> CronScheduleBuilder.cronSchedule(scheduleJo</span><br><span class="line">                    b.getCronExpression())</span><br><span class="line">                    .withMisfireHandlingInstructionDoNothing();</span><br><span class="line">            <span class="type">CronTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> getCronTrigger(scheduler, scheduleJob.getJobId());</span><br><span class="line"><span class="comment">//按新的cronExpression表达式重新构建trigger</span></span><br><span class="line">            trigger = trigger.getTriggerBuilder().withIdentity(triggerKey).withSchedule(sched</span><br><span class="line">                    uleBuilder).build();</span><br><span class="line"><span class="comment">//参数</span></span><br><span class="line">            trigger.getJobDataMap().put(ScheduleJobEntity.JOB_PARAM_KEY, <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(sc</span><br><span class="line">                    heduleJob));</span><br><span class="line">            scheduler.rescheduleJob(triggerKey, trigger);</span><br><span class="line"><span class="comment">//暂停任务</span></span><br><span class="line">            <span class="keyword">if</span> (scheduleJob.getStatus() == ScheduleStatus.PAUSE.getValue()) &#123;</span><br><span class="line">                pauseJob(scheduler, scheduleJob.getJobId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;更新定时任务失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 立即执行任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(Scheduler scheduler, ScheduleJobEntity scheduleJob)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//参数</span></span><br><span class="line">            <span class="type">JobDataMap</span> <span class="variable">dataMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JobDataMap</span>();</span><br><span class="line">            dataMap.put(ScheduleJobEntity.JOB_PARAM_KEY, <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(scheduleJob));</span><br><span class="line">            scheduler.triggerJob(getJobKey(scheduleJob.getJobId()), dataMap);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;立即执行定时任务失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 暂停任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">pauseJob</span><span class="params">(Scheduler scheduler, Long jobId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            scheduler.pauseJob(getJobKey(jobId));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;暂停定时任务失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 恢复任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">resumeJob</span><span class="params">(Scheduler scheduler, Long jobId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            scheduler.resumeJob(getJobKey(jobId));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;暂停定时任务失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除定时任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deleteScheduleJob</span><span class="params">(Scheduler scheduler, Long jobId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            scheduler.deleteJob(getJobKey(jobId));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;删除定时任务失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是几个核心的方法：</p>
<ul>
<li><p>createScheduleJob【创建定时任务】：在管理后台新增任务时，会调用该方法，把任务添加到Quartz 中，再根据cron表达式，定时执行任务。</p>
</li>
<li><p>updateScheduleJob【更新定时任务】：修改任务时，调用该方法，修改Quartz中的任务信息。</p>
</li>
<li><p>run【立即执行定时任务】：马上执行一次该任务，只执行一次。</p>
</li>
<li><p>pauseJob【暂停定时任务】：这个不是暂停正在执行的任务，而是以后不再执行这个定时任务了。正在 执行的任务，还是照常执行完。</p>
</li>
<li><p>resumeJob【恢复定时任务】：这个是针对pauseJob来的，如果任务暂停了，以后都不会再执行，要想再执行，则需要调用resumeJob，使定时任务恢复执行。</p>
</li>
<li><p>deleteScheduleJob【删除定时任务】：删除定时任务</p>
</li>
</ul>
<p>其中， <code>createScheduleJob</code> 、 <code>updateScheduleJob</code> 在启动项目的时候，也会调用，把数据库里，新增或修 改的任务，更新到Quartz中，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Service(&quot;scheduleJobService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduleJobServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ScheduleJobService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 项目启动时，初始化定时器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;ScheduleJobEntity&gt; scheduleJobList = schedulerJobDao.queryList(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        <span class="keyword">for</span> (ScheduleJobEntity scheduleJob : scheduleJobList) &#123;</span><br><span class="line">            <span class="type">CronTrigger</span> <span class="variable">cronTrigger</span> <span class="operator">=</span> ScheduleUtils.getCronTrigger(scheduler, scheduleJob.getJobId());</span><br><span class="line">            <span class="comment">//如果不存在，则创建</span></span><br><span class="line">            <span class="keyword">if</span> (cronTrigger == <span class="literal">null</span>) &#123;</span><br><span class="line">                ScheduleUtils.createScheduleJob(scheduler, scheduleJob);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ScheduleUtils.updateScheduleJob(scheduler, scheduleJob);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大家是不是还有疑问呢，怎么就能定时执行，刚才在管理后台新增的任务testTask呢？ 下面我们再来分析 下 createScheduleJob 方法，创建定时任务的时候，要调用该方法，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构建一个新的定时任务，JobBuilder.newJob()只能接受Job类型的参数</span></span><br><span class="line"><span class="comment">//把ScheduleJob.class作为参数传进去，ScheduleJob继承QuartzJobBean，而QuartzJobBean实现了Job接口</span></span><br><span class="line">JobDetail jobDetail=JobBuilder.newJob(ScheduleJob.class).withIdentity(getJobKey(scheduleJob.getJobId())).build();</span><br><span class="line"><span class="comment">//构建cron，定时任务的周期</span></span><br><span class="line">        CronScheduleBuilder scheduleBuilder=CronScheduleBuilder.cronSchedule(scheduleJob.getCronExpression()).withMisfireHandlingInstructionDoNothing();</span><br><span class="line"><span class="comment">//根据cron，构建一个CronTrigger</span></span><br><span class="line">        CronTrigger trigger=TriggerBuilder.newTrigger().withIdentity(getTriggerKey(scheduleJob.getJobId())).withSchedule(scheduleBuilder).build();</span><br><span class="line"><span class="comment">//放入参数，运行时的方法可以获取</span></span><br><span class="line">        jobDetail.getJobDataMap().put(ScheduleJobEntity.JOB_PARAM_KEY,<span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(scheduleJob));</span><br><span class="line"><span class="comment">//把任务添加到Quartz中</span></span><br><span class="line">        scheduler.scheduleJob(jobDetail,trigger);</span><br></pre></td></tr></table></figure>

<p>把任务添加到 Quartz 后，等cron定义的时间周期到了，就会执行 ScheduleJob 类的 executeInternal 方 法， ScheduleJob 代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduleJob</span> <span class="keyword">extends</span> <span class="title class_">QuartzJobBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line">        <span class="type">ScheduleJobEntity</span> <span class="variable">scheduleJob</span> <span class="operator">=</span> (ScheduleJobEntity) context.getMergedJobDataMap()</span><br><span class="line">                .get(ScheduleJobEntity.JOB_PARAM_KEY);</span><br><span class="line">        <span class="comment">//获取spring bean</span></span><br><span class="line">        <span class="type">ScheduleJobLogService</span> <span class="variable">scheduleJobLogService</span> <span class="operator">=</span> (ScheduleJobLogService) SpringContextUt</span><br><span class="line">        ils.getBean(<span class="string">&quot;scheduleJobLogService&quot;</span>);</span><br><span class="line">        <span class="comment">//数据库保存执行记录</span></span><br><span class="line">        <span class="type">ScheduleJobLogEntity</span> <span class="variable">log</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScheduleJobLogEntity</span>();</span><br><span class="line">        log.setJobId(scheduleJob.getJobId());</span><br><span class="line">        log.setBeanName(scheduleJob.getBeanName());</span><br><span class="line">        log.setParams(scheduleJob.getParams());</span><br><span class="line">        log.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="comment">//任务开始时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//执行任务 </span></span><br><span class="line">            logger.info(<span class="string">&quot;任务准备执行，任务ID：&quot;</span> + scheduleJob.getJobId());</span><br><span class="line"></span><br><span class="line">            <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> SpringContextUtils.getBean(scheduleJob.getBeanName());</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> target.getClass().getDeclaredMethod(<span class="string">&quot;run&quot;</span>, String.class);</span><br><span class="line">            method.invoke(target, scheduleJob.getParams());</span><br><span class="line">            <span class="comment">//任务执行总时长 </span></span><br><span class="line">            <span class="type">long</span> <span class="variable">times</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">            log.setTimes((<span class="type">int</span>) times);</span><br><span class="line">            <span class="comment">//任务状态 0 ：成功 1 ：失败</span></span><br><span class="line"></span><br><span class="line">            log.setStatus(<span class="number">0</span>);</span><br><span class="line">            logger.info(<span class="string">&quot;任务执行完毕，任务ID：&quot;</span> + scheduleJob.getJobId() + <span class="string">&quot; 总共耗时：&quot;</span> + tim es + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;任务执行失败，任务ID：&quot;</span> + scheduleJob.getJobId(), e);</span><br><span class="line">            <span class="comment">//任务执行总时长</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">times</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">            log.setTimes((<span class="type">int</span>) times);</span><br><span class="line">            <span class="comment">//任务状态 0 ：成功 1 ：失败 </span></span><br><span class="line">            log.setStatus(<span class="number">1</span>);</span><br><span class="line">            log.setError(StringUtils.substring(e.toString(), <span class="number">0</span>, <span class="number">2000</span>));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            scheduleJobLogService.save(log);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-13-云存储模块-1"><a href="#6-13-云存储模块-1" class="headerlink" title="6.13 云存储模块"></a>6.13 云存储模块</h2><blockquote>
<p>图片、文件上传，使用的是七牛、阿里云、腾讯云的存储服务，不能上传到本地服务器。上传到本地 服务器，不利于维护，访问速度慢等缺点，所以推荐使用云存储服务。</p>
</blockquote>
<h3 id="6-13-1-七牛的配置"><a href="#6-13-1-七牛的配置" class="headerlink" title="6.13.1 七牛的配置"></a>6.13.1 七牛的配置</h3><blockquote>
<p>如果没有七牛账号，则需要注册七牛账号，才能进行配置，下面演示注册七牛账号并配置，步骤如 下：</p>
</blockquote>
<ol>
<li>[注册七牛账号][34]，并登录后，再创建七牛空间，如下图：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/86h4oq.png"></p>
<ol start="2">
<li>进入管理后端，填写七牛配置信息，如下图：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/tkisAZ.png"></p>
<p>必填项有域名、AccessKey、SecretKey、空间名。其中，空间名就是才创建的空间名 ios-app ，填进去就可 以了。域名、AccessKey、SecretKey可以通过下图找到：</p>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/v0K61m.png"></p>
<h3 id="6-13-2-阿里云的配置"><a href="#6-13-2-阿里云的配置" class="headerlink" title="6.13.2 阿里云的配置"></a>6.13.2 阿里云的配置</h3><ul>
<li>进入管理后端，填写阿里云配置信息，如下图：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/bHjijJ.png"></p>
<ul>
<li>进去阿里云管理后台，并创建Bucket，如下图：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/zEeaHL.png"></p>
<ul>
<li>通过下面的界面，可以找到域名、BucketName、EndPoint</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/tB5WLW.png"></p>
<ul>
<li>通过下面的界面，可以找到AccessKeyId、AccessKeySecret</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/DIzny3.png"></p>
<h4 id="6-13-3-腾讯云的配置"><a href="#6-13-3-腾讯云的配置" class="headerlink" title="6.13.3 腾讯云的配置"></a>6.13.3 腾讯云的配置</h4><ul>
<li>进入管理后端，填写腾讯云配置信息，如下图：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/lH6UMH.png"></p>
<ul>
<li>进去腾讯云管理后台，并创建Bucket，如下图：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/UGXMhL.png"></p>
<ul>
<li>通过下面的界面，可以找到域名、BucketName、Bucket所属地区</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/rLnoLL.png"></p>
<ul>
<li>通过下面的界面，可以找到AppId、SecretId、SecretKey</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/2022/03/18/7XxX9S.png"></p>
<h4 id="6-13-4-源码分析"><a href="#6-13-4-源码分析" class="headerlink" title="6.13.4 源码分析"></a>6.13.4 源码分析</h4><p>本项目的文件上传，使用的是七牛、阿里云、腾讯云，则需要引入他们的SDK，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.qiniu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>qiniu-java-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;qiniu.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun.oss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-sdk-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;aliyun.oss.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.qcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cos_api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;qcloud.cos.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>定义抽象类 CloudStorageService ，用来声明上传的公共接口，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CloudStorageService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 云存储配置信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CloudStorageConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件路径</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefix 前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> suffix 后缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回上传路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPath</span><span class="params">(String prefix, String suffix)</span> &#123;</span><br><span class="line">        <span class="comment">//生成uuid</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">//文件路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> DateUtils.format(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="string">&quot;yyyyMMdd&quot;</span>) + <span class="string">&quot;/&quot;</span> + uuid;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(prefix)) &#123;</span><br><span class="line">            path = prefix + <span class="string">&quot;/&quot;</span> + path;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path + suffix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data 文件字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path 文件路径，包含文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回http地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title function_">upload</span><span class="params">(<span class="type">byte</span>[] data, String path)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data   文件字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> suffix 后缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回http地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title function_">uploadSuffix</span><span class="params">(<span class="type">byte</span>[] data, String suffix)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputStream 字节流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path        文件路径，包含文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回http地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title function_">upload</span><span class="params">(InputStream inputStream, String path)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputStream 字节流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> suffix      后缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回http地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title function_">uploadSuffix</span><span class="params">(InputStream inputStream, String suffix)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>七牛上传的实现，只需继承 CloudStorageService ，并实现相应的上传接口，如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.qiniu.common.Zone;</span><br><span class="line"><span class="keyword">import</span> com.qiniu.http.Response;</span><br><span class="line"><span class="keyword">import</span> com.qiniu.storage.Configuration;</span><br><span class="line"><span class="keyword">import</span> com.qiniu.storage.UploadManager;</span><br><span class="line"><span class="keyword">import</span> com.qiniu.util.Auth;</span><br><span class="line"><span class="keyword">import</span> io.renren.common.exception.RRException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 七牛云存储</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QiniuCloudStorageService</span> <span class="keyword">extends</span> <span class="title class_">CloudStorageService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UploadManager uploadManager;</span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">QiniuCloudStorageService</span><span class="params">(CloudStorageConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.config = config;</span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        uploadManager = <span class="keyword">new</span> <span class="title class_">UploadManager</span>(<span class="keyword">new</span> <span class="title class_">Configuration</span>(Zone.autoZone()));</span><br><span class="line">        token = Auth.create(config.getQiniuAccessKey(), config.getQiniuSecretKey()).</span><br><span class="line">                uploadToken(config.getQiniuBucketName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(<span class="type">byte</span>[] data, String path)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Response</span> <span class="variable">res</span> <span class="operator">=</span> uploadManager.put(data, path, token);</span><br><span class="line">            <span class="keyword">if</span> (!res.isOK()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;上传七牛出错：&quot;</span> + res.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;上传文件失败，请核对七牛配置信息&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config.getQiniuDomain() + <span class="string">&quot;/&quot;</span> + path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(InputStream inputStream, String path)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] data = IOUtils.toByteArray(inputStream);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.upload(data, path);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;上传文件失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadSuffix</span><span class="params">(<span class="type">byte</span>[] data, String suffix)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> upload(data, getPath(config.getQiniuPrefix(), suffix));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadSuffix</span><span class="params">(InputStream inputStream, String suffix)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> upload(inputStream, getPath(config.getQiniuPrefix(), suffix));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>阿里云上传的实现，只需继承 CloudStorageService ，并实现相应的上传接口，如下所示</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSClient;</span><br><span class="line"><span class="keyword">import</span> io.renren.common.exception.RRException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阿里云存储</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliyunCloudStorageService</span> <span class="keyword">extends</span> <span class="title class_">CloudStorageService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> OSSClient client;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AliyunCloudStorageService</span><span class="params">(CloudStorageConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.config = config;</span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">OSSClient</span>(config.getAliyunEndPoint(), config.getAliyunAccessKeyId(),</span><br><span class="line">                config.getAliyunAccessKeySecret());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(<span class="type">byte</span>[] data, String path)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> upload(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(data), path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(InputStream inputStream, String path)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client.putObject(config.getAliyunBucketName(), path, inputStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;上传文件失败，请检查配置信息&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config.getAliyunDomain() + <span class="string">&quot;/&quot;</span> + path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadSuffix</span><span class="params">(<span class="type">byte</span>[] data, String suffix)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> upload(data, getPath(config.getAliyunPrefix(), suffix));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadSuffix</span><span class="params">(InputStream inputStream, String suffix)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> upload(inputStream, getPath(config.getAliyunPrefix(), suffix));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>腾讯云上传的实现，只需继承 CloudStorageService ，并实现相应的上传接口，如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.qcloud.cos.COSClient;</span><br><span class="line"><span class="keyword">import</span> com.qcloud.cos.ClientConfig;</span><br><span class="line"><span class="keyword">import</span> com.qcloud.cos.request.UploadFileRequest;</span><br><span class="line"><span class="keyword">import</span> com.qcloud.cos.sign.Credentials;</span><br><span class="line"><span class="keyword">import</span> io.renren.common.exception.RRException;</span><br><span class="line"><span class="keyword">import</span> net.sf.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 腾讯云存储</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark sunlightcs@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QcloudCloudStorageService</span> <span class="keyword">extends</span> <span class="title class_">CloudStorageService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> COSClient client;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">QcloudCloudStorageService</span><span class="params">(CloudStorageConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.config = config;</span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Credentials</span> <span class="variable">credentials</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Credentials</span>(config.getQcloudAppId(), config.getQcloudSe</span><br><span class="line">                <span class="title function_">cretId</span><span class="params">()</span>,</span><br><span class="line">                config.getQcloudSecretKey());</span><br><span class="line"><span class="comment">//初始化客户端配置</span></span><br><span class="line">        <span class="type">ClientConfig</span> <span class="variable">clientConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientConfig</span>();</span><br><span class="line"><span class="comment">//设置bucket所在的区域，华南：gz 华北：tj 华东：sh</span></span><br><span class="line">        clientConfig.setRegion(config.getQcloudRegion());</span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">COSClient</span>(clientConfig, credentials);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(<span class="type">byte</span>[] data, String path)</span> &#123;</span><br><span class="line"><span class="comment">//腾讯云必需要以&quot;/&quot;开头</span></span><br><span class="line">        <span class="keyword">if</span> (!path.startsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">            path = <span class="string">&quot;/&quot;</span> + path;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//上传到腾讯云</span></span><br><span class="line">        <span class="type">UploadFileRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileRequest</span>(config.getQcloudBucketName(), path,</span><br><span class="line">                data);</span><br><span class="line">        <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> client.uploadFile(request);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONObject.fromObject(response);</span><br><span class="line">        <span class="keyword">if</span> (jsonObject.getInt(<span class="string">&quot;code&quot;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;文件上传失败，&quot;</span> + jsonObject.getString(<span class="string">&quot;message&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config.getQcloudDomain() + path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(InputStream inputStream, String path)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] data = IOUtils.toByteArray(inputStream);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.upload(data, path);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;上传文件失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadSuffix</span><span class="params">(<span class="type">byte</span>[] data, String suffix)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> upload(data, getPath(config.getQcloudPrefix(), suffix));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadSuffix</span><span class="params">(InputStream inputStream, String suffix)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> upload(inputStream, getPath(config.getQcloudPrefix(), suffix));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对外提供了OSSFactory工厂，可方便业务的调用，如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">OSSFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SysConfigService sysConfigService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        OSSFactory.sysConfigService = (SysConfigService) SpringContextUtils.getBean(<span class="string">&quot;sysConfi</span></span><br><span class="line"><span class="string">                gService&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CloudStorageService <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//获取云存储配置信息</span></span><br><span class="line">        <span class="type">CloudStorageConfig</span> <span class="variable">config</span> <span class="operator">=</span> sysConfigService.getConfigObject(ConfigConstant.CLOUD_STO</span><br><span class="line">                RAGE_CONFIG_KEY, CloudStorageConfig.class);</span><br><span class="line">        <span class="keyword">if</span> (config.getType() == Constant.CloudService.QINIU.getValue()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QiniuCloudStorageService</span>(config);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.getType() == Constant.CloudService.ALIYUN.getValue()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AliyunCloudStorageService</span>(config);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.getType() == Constant.CloudService.QCLOUD.getValue()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QcloudCloudStorageService</span>(config);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>文件上传的例子，如下： @RequestMapping(“&#x2F;upload”)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">if</span>(file.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(<span class="string">&quot;上传文件不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//上传文件，并返回文件的http地址</span></span><br><span class="line">        String url=OSSFactory.build().upload(file.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-14-APP-模块-1"><a href="#6-14-APP-模块-1" class="headerlink" title="6.14 APP 模块"></a>6.14 APP 模块</h2><blockquote>
<p>APP模块，是针对APP使用的，如IOS、Android等，主要是解决用户认证的问题。</p>
</blockquote>
<h3 id="6-14-1-APP-的使用"><a href="#6-14-1-APP-的使用" class="headerlink" title="6.14.1 APP 的使用"></a>6.14.1 APP 的使用</h3><blockquote>
<p>APP的设计思路：用户通过APP，输入手机号、密码登录后，系统会生成与登录用户一一对应的 token，用户调用需要登录的接口时，只需把token传过来，服务端就知道是谁在访问接口，token如果过期，则拒绝访问，从而保证系统的安全性。</p>
</blockquote>
<p>使用很简单，看看下面的例子，就会使用了。仔细观察，我们会发现，有 2 个自定义的注解。其中， @LoginUser注解是获取当前登录用户的信息，有哪些信息，下面会分析的。@Login注解则是需要用户认证，没有登录的用户，不能访问该接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.renren.modules.app.annotation.Login;</span><br><span class="line"><span class="keyword">import</span> io.renren.modules.app.annotation.LoginUser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestAttribute;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/app&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiTestController</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Login</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;userInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">userInfo</span><span class="params">(<span class="meta">@LoginUser</span> UserEntity user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> R.ok().put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Login</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">userInfo</span><span class="params">(<span class="meta">@RequestAttribute(&quot;userId&quot;)</span> Integer userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> R.ok().put(<span class="string">&quot;userId&quot;</span>, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 忽略Token验证测试</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;notToken&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">notToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> R.ok().put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;无需token也能访问。。。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-14-2-源码分析"><a href="#6-14-2-源码分析" class="headerlink" title="6.14.2 源码分析"></a>6.14.2 源码分析</h3><ul>
<li>我们先来看看，APP用户登录的时候，都干了那些事情，如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/app&quot;)</span></span><br><span class="line"><span class="meta">@Api(&quot;APP登录接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiLoginController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtUtils jwtUtils;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;login&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;登录&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> LoginForm form)</span> &#123;</span><br><span class="line">				<span class="comment">//表单校验</span></span><br><span class="line">        ValidatorUtils.validateEntity(form);</span><br><span class="line">				<span class="comment">//用户登录</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">userId</span> <span class="operator">=</span> userService.login(form);</span><br><span class="line">				<span class="comment">//生成token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> jwtUtils.generateToken(userId);</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;token&quot;</span>, token);</span><br><span class="line">        map.put(<span class="string">&quot;expire&quot;</span>, jwtUtils.getExpire());</span><br><span class="line">        <span class="keyword">return</span> R.ok(map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * jwt工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;renren.jwt&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtils</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(getClass());</span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> expire;</span><br><span class="line">    <span class="keyword">private</span> String header;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成jwt token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateToken</span><span class="params">(<span class="type">long</span> userId)</span> &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">nowDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">				<span class="comment">//过期时间</span></span><br><span class="line">        <span class="type">Date</span> <span class="variable">expireDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(nowDate.getTime() + expire * <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> Jwts.builder()</span><br><span class="line">                .setHeaderParam(<span class="string">&quot;typ&quot;</span>, <span class="string">&quot;JWT&quot;</span>)</span><br><span class="line">                .setSubject(userId + <span class="string">&quot;&quot;</span>)</span><br><span class="line">                .setIssuedAt(nowDate)</span><br><span class="line">                .setExpiration(expireDate)</span><br><span class="line">                .signWith(SignatureAlgorithm.HS512, secret)</span><br><span class="line">                .compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Claims <span class="title function_">getClaimByToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                    .setSigningKey(secret)</span><br><span class="line">                    .parseClaimsJws(token)</span><br><span class="line">                    .getBody();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;validate is token error &quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * token是否过期</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true：过期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isTokenExpired</span><span class="params">(Date expiration)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> expiration.before(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSecret</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> secret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSecret</span><span class="params">(String secret)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.secret = secret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getExpire</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setExpire</span><span class="params">(<span class="type">long</span> expire)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.expire = expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getHeader</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> header;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHeader</span><span class="params">(String header)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.header = header;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们从上面的代码，可以看到，用户每次登录的时候，都会生成一个唯一的token，这个token是通过jwt生成 的。</p>
<ul>
<li>APP模块的核心配置，如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.renren.modules.api.interceptor.AuthorizationInterceptor;</span><br><span class="line"><span class="keyword">import</span> io.renren.modules.api.resolver.LoginUserHandlerMethodArgumentResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.support.HandlerMethodArgumentResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthorizationInterceptor authorizationInterceptor;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginUserHandlerMethodArgumentResolver loginUserHandlerMethodArgumentResolver;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(authorizationInterceptor).addPathPatterns(<span class="string">&quot;/app/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addArgumentResolvers</span><span class="params">(List&lt;HandlerMethodArgumentResolver&gt; argumentResolvers)</span> &#123;</span><br><span class="line">        argumentResolvers.add(loginUserHandlerMethodArgumentResolver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到，配置了个Interceptor，用来拦截 &#x2F;app 开头的所有请求，拦截后，会到 AuthorizationInterceptor类preHandle方法处理。只有以 &#x2F;app开头的请求，API模块认证才会起作用，如果要以&#x2F;api 开头，则需要修改此处。还配置了argumentResolver，别忽略了啊，下面会讲解。</p>
<p>温馨提示，别忘了配置shiro，不然会被shiro拦截掉的，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(&quot;shiroFilter&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shirFilter</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line"><span class="comment">//部分代码省略...</span></span><br><span class="line">        Map&lt;String, String&gt; filterMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//让shiro放过，以/app开头的请求</span></span><br><span class="line">        filterMap.put(<span class="string">&quot;/app/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line"><span class="comment">//部分代码省略...</span></span><br><span class="line">        shiroFilter.setFilterChainDefinitionMap(filterMap);</span><br><span class="line">        <span class="keyword">return</span> shiroFilter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>分析AuthorizationInterceptor类，我们可以发现，拦截 &#x2F;app 开头的请求后，都干了些什么，如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.renren.common.exception.RRException;</span><br><span class="line"><span class="keyword">import</span> io.renren.modules.app.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> io.renren.modules.app.annotation.Login;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.HandlerMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.HandlerInterceptorAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 权限(Token)验证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">HandlerInterceptorAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtUtils jwtUtils;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_KEY</span> <span class="operator">=</span> <span class="string">&quot;userId&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object</span></span><br><span class="line"><span class="params">            handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Login annotation;</span><br><span class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> HandlerMethod) &#123;</span><br><span class="line">            annotation = ((HandlerMethod) handler).getMethodAnnotation(Login.class);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (annotation == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">//获取用户凭证</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(jwtUtils.getHeader());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(token)) &#123;</span><br><span class="line">            token = request.getParameter(jwtUtils.getHeader());</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">//凭证为空</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(token)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(jwtUtils.getHeader() + <span class="string">&quot;不能为空&quot;</span>, HttpStatus.UNAUTHORIZED.v</span><br><span class="line">                    <span class="title function_">alue</span><span class="params">()</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> jwtUtils.getClaimByToken(token);</span><br><span class="line">        <span class="keyword">if</span> (claims == <span class="literal">null</span> || jwtUtils.isTokenExpired(claims.getExpiration())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RRException</span>(jwtUtils.getHeader() + <span class="string">&quot;失效，请重新登录&quot;</span>, HttpStatus.UNAUTHO</span><br><span class="line">                    RIZED.value());</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">//设置userId到request里，后续根据userId，获取用户信息</span></span><br><span class="line">        request.setAttribute(USER_KEY, Long.parseLong(claims.getSubject()));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以发现，进入 &#x2F;app 请求的接口之前，会判断请求的接口，是否加了@Login注解(需要token认证)，如果没有@Login注解，则不验证token，可以直接访问接口。如果有@Login注解，则需要验证token的正确性，并把userId放到request的USER_KEY里，后续会用到。</p>
<ul>
<li>此时，@Login注解的作用，相信大家都明白了。再看看下面的代码，加了@LoginUser注解后，user对象里，就变成当前登录用户的信息，这是什么时候设置进去的呢？</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;userInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">userInfo</span><span class="params">(<span class="meta">@LoginUser</span> UserEntity user)</span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> R.ok().put(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>设置user对象进去，其实是在LoginUserHandlerMethodArgumentResolver里干的,LoginUserHandlerMethodArgumentResolver是我们自定义的参数转换器，只要实现HandlerMethodArgumentResolver接口即可，代码如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.renren.modules.api.annotation.LoginUser;</span><br><span class="line"><span class="keyword">import</span> io.renren.modules.api.entity.UserEntity;</span><br><span class="line"><span class="keyword">import</span> io.renren.modules.api.interceptor.AuthorizationInterceptor;</span><br><span class="line"><span class="keyword">import</span> io.renren.modules.api.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.support.WebDataBinderFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.NativeWebRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.support.HandlerMethodArgumentResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.support.ModelAndViewContainer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginUserHandlerMethodArgumentResolver</span> <span class="keyword">implements</span> <span class="title class_">HandlerMethodArgumentResolver</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsParameter</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line"><span class="comment">//如果方法的参数是UserEntity，且参数前面有@LoginUser注解，则进入resolveArgument方法，进行</span></span><br><span class="line">        处理</span><br><span class="line">        <span class="keyword">return</span> parameter.getParameterType().isAssignableFrom(UserEntity.class) &amp;&amp; parameter.h</span><br><span class="line">        <span class="title function_">asParameterAnnotation</span><span class="params">(LoginUser.class)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer container,</span></span><br><span class="line"><span class="params">                                  NativeWebRequest request, WebDataBinderFactory factory)</span> thr</span><br><span class="line"></span><br><span class="line">    ows Exception</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"><span class="comment">//获取用户ID，之前设置进去的，还有印象吧</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> request.getAttribute(AuthorizationInterceptor.USER_KEY, RequestAttrib</span><br><span class="line">                utes.SCOPE_REQUEST);</span><br><span class="line">        <span class="keyword">if</span> (object == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//通过userId，获取用户信息</span></span><br><span class="line">        <span class="type">UserEntity</span> <span class="variable">user</span> <span class="operator">=</span> userService.queryObject((Long) object);</span><br><span class="line"><span class="comment">//把当前用户信息，设置到UserEntity参数的user对象里</span></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="第-7-章-生产环境部署"><a href="#第-7-章-生产环境部署" class="headerlink" title="第 7 章 生产环境部署"></a>第 7 章 生产环境部署</h1><blockquote>
<p>部署项目前，需要准备JDK8、Maven、MySQL5.5+环境，参考开发环境搭建。</p>
</blockquote>
<h2 id="7-1-jar-包部署"><a href="#7-1-jar-包部署" class="headerlink" title="7.1 jar 包部署"></a>7.1 jar 包部署</h2><h2 id="7-2-docker-部署"><a href="#7-2-docker-部署" class="headerlink" title="7.2 docker 部署"></a>7.2 docker 部署</h2><h2 id="7-3-集群部署"><a href="#7-3-集群部署" class="headerlink" title="7.3 集群部署"></a>7.3 集群部署</h2><h3 id="7-1-jar-包部署-1"><a href="#7-1-jar-包部署-1" class="headerlink" title="7.1 jar 包部署"></a>7.1 jar 包部署</h3><blockquote>
<p>Spring Boot项目，推荐打成jar包的方式，部署到服务器上。</p>
</blockquote>
<ul>
<li>Spring Boot内置了Tomcat，可配置Tomcat的端口号、初始化线程数、最大线程数、连接超时时长、https 等等，如下所示：</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">tomcat:</span></span><br><span class="line">    <span class="attr">uri-encoding:</span> <span class="string">UTF-8</span></span><br><span class="line">    <span class="attr">max-threads:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">min-spare-threads:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">connection-timeout:</span> <span class="string">5000ms</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/renren-fast</span></span><br><span class="line">    <span class="attr">session:</span></span><br><span class="line">    <span class="attr">cookie:</span></span><br><span class="line">    <span class="attr">http-only:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">ssl:</span></span><br><span class="line">    <span class="attr">key-store:</span> <span class="string">classpath:.keystore</span></span><br><span class="line">    <span class="attr">key-store-type:</span> <span class="string">JKS</span></span><br><span class="line">    <span class="attr">key-password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">key-alias:</span> <span class="string">tomcat</span></span><br></pre></td></tr></table></figure>

<ul>
<li>当然，还可以指定jvm的内存大小，如下所示：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xms4g -Xmx4g -Xmn1g -server -jar renren-fast.jar</span><br></pre></td></tr></table></figure>

<ul>
<li>在windows下部署，只需打开cmd窗口，输入如下命令：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar renren-fast.jar --spring.profiles.active=prod</span><br></pre></td></tr></table></figure>

<ul>
<li>在Linux下部署，只需输入如下命令，即可在Linux后台运行：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> java -jar renren-fast.jar --spring.profiles.active=prod &gt; renren.log &amp;</span><br></pre></td></tr></table></figure>

<ul>
<li>在Linux环境下，我们一般可以创建shell脚本，用于重启项目，如下所示：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建启动的shell脚本</span></span><br><span class="line">[root@renren renren-fast]<span class="comment"># vim start.sh</span></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">process=`ps -fe|grep <span class="string">&quot;renren-fast.jar&quot;</span> |grep -ivE <span class="string">&quot;grep|cron&quot;</span> |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ !<span class="variable">$process</span> ];</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;stop erp process <span class="variable">$process</span> .....&quot;</span></span><br><span class="line">		<span class="built_in">kill</span> -9 <span class="variable">$process</span></span><br><span class="line">    <span class="built_in">sleep</span> 1 </span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;start erp process.....&quot;</span></span><br><span class="line"><span class="built_in">nohup</span> java -Dspring.profiles.active=prod -jar renren-fast.jar --server.port=8080 --server.servlet.context-path=/renren-fast 2&gt;&amp;1 | cronolog <span class="built_in">log</span>.%Y-%m-%d.out &gt;&gt; /dev/null &amp;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;start erp success!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#通过shell脚本启动项目</span></span><br><span class="line">[root@renren renren-fast]<span class="comment"># yum install -y cronolog</span></span><br><span class="line">[root@renren renren-fast]<span class="comment"># chomd +x start.sh</span></span><br><span class="line">[root@renren renren-fast]<span class="comment"># ./start.sh</span></span><br></pre></td></tr></table></figure>

<h2 id="7-2-docker-部署-1"><a href="#7-2-docker-部署-1" class="headerlink" title="7.2 docker 部署"></a>7.2 docker 部署</h2><p>安装docker环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装docker</span></span><br><span class="line">[root@mark ~]<span class="comment"># curl -sSL https://get.docker.com/ | sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动docker</span></span><br><span class="line">[root@mark ~]<span class="comment"># service docker start</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看docker版本信息</span></span><br><span class="line">[root@mark ~]<span class="comment"># docker version</span></span><br><span class="line">Client:</span><br><span class="line">    Version: 17.07.0-ce</span><br><span class="line">    API version: 1.31</span><br><span class="line">    Go version: go1.8.3</span><br><span class="line">    Git commit: 8784753</span><br><span class="line">    Built: Tue Aug 29 17:42:01 2017</span><br><span class="line">    OS/Arch: linux/amd64</span><br><span class="line">Server:</span><br><span class="line">    Version: 17.07.0-ce</span><br><span class="line">    API version: 1.31 (minimum version 1.12)</span><br><span class="line">    Go version: go1.8.3</span><br><span class="line">    Git commit: 8784753</span><br><span class="line">    Built: Tue Aug 29 17:43:23 2017</span><br><span class="line">    OS/Arch: linux/amd64</span><br><span class="line">    Experimental: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>还需要准备java、maven环境，请自行安装</li>
<li>通过maven插件，构建docker镜像</li>
</ul>
<h2 id="打包并构建项目镜像"><a href="#打包并构建项目镜像" class="headerlink" title="打包并构建项目镜像"></a>打包并构建项目镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@mark renren-fast]<span class="comment"># mvn clean package docker:build</span></span><br><span class="line"><span class="comment">#省略打包log...</span></span><br><span class="line">[INFO] Building image renren/fast</span><br><span class="line">Step 1/6 : FROM java:8</span><br><span class="line">	---&gt; d23bdf5b1b1b</span><br><span class="line">Step 2/6 : EXPOSE 8080</span><br><span class="line">    ---&gt; Using cache</span><br><span class="line">    ---&gt; 8e33aadb2c18</span><br><span class="line">Step 3/6 : VOLUME /tmp</span><br><span class="line">  ---&gt; Using cache</span><br><span class="line">  ---&gt; c5dc0c509062</span><br><span class="line">Step 4/6 : ADD renren-fast-1.2.0.jar /app.jar</span><br><span class="line">  ---&gt; 831bc3ca84bc</span><br><span class="line">Step 5/6 : RUN bash -c <span class="string">&#x27;touch /app.jar&#x27;</span></span><br><span class="line">  ---&gt; Running <span class="keyword">in</span> fe3ef9343e4c</span><br><span class="line">  ---&gt; b3d6dd6fc297</span><br><span class="line">Removing intermediate container fe3ef9343e4c</span><br><span class="line">Step 6/6 : ENTRYPOINT java -jar /app.jar</span><br><span class="line">  ---&gt; Running <span class="keyword">in</span> 89adce4ae167</span><br><span class="line">  ---&gt; a4ae60970a77</span><br><span class="line">Removing intermediate container 89adce4ae167</span><br><span class="line">ProgressMessage&#123;<span class="built_in">id</span>=null, status=null, stream=null, error=null, progress=null, progressDetail=</span><br><span class="line">null&#125;</span><br><span class="line">Successfully built a4ae60970a77</span><br><span class="line">Successfully tagged renren/fast:latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看镜像</span></span><br><span class="line">[root@mark renren-fast]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY 		TAG 		IMAGE ID 				 CREATED 					SIZE</span><br><span class="line">renren/fast 	latest 	a4ae60970a77 		 14 seconds ago 	714MB</span><br><span class="line">java 					8 			d23bdf5b1b1b 		 7 months ago 		643MB</span><br></pre></td></tr></table></figure>

<ul>
<li>安装docker-compose，用来管理容器</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载地址：https://github.com/docker/compose/releases</span></span><br><span class="line"><span class="comment">#下载docker-compose</span></span><br><span class="line">[root@mark renren-fast]<span class="comment"># curl -L https://github.com/docker/compose/releases/download/1.16.1/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose</span></span><br><span class="line"><span class="comment">#增加可执行权限</span></span><br><span class="line">[root@mark renren-fast]<span class="comment"># chmod +x /usr/local/bin/docker-compose</span></span><br><span class="line"><span class="comment">#查看版本信息</span></span><br><span class="line">[root@mark renren-fast]<span class="comment"># docker-compose version</span></span><br><span class="line">docker-compose version 1.16.1, build 6d1ac21</span><br><span class="line">docker-py version: 2.5.1</span><br><span class="line">CPython version: 2.7.13</span><br><span class="line">OpenSSL version: OpenSSL 1.0.1t 3 May 2016</span><br></pre></td></tr></table></figure>

<p>如果下载不了，可以用迅雷将<a target="_blank" rel="noopener" href="https://github.com/docker/compose/releases/download/1.16.1/docker-compose-">https://github.com/docker/compose/releases/download/1.16.1/docker-compose-</a><br>Linux-x86_64下载到本地，再上传到服务器</p>
<ul>
<li>通过docker-compose，启动项目，如下所示：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动项目</span></span><br><span class="line">[root@mark renren-fast]<span class="comment"># docker-compose up -d</span></span><br><span class="line">Creating network <span class="string">&quot;renrenfast_default&quot;</span> with the default driver</span><br><span class="line">Creating renrenfast_campus_1 ...</span><br><span class="line">Creating renrenfast_campus_1 ... <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看启动的容器</span></span><br><span class="line">[root@mark renren-fast]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID 	IMAGE 			COMMAND 							CREATED 						STATUS 				PORTS 				</span><br><span class="line">NAMES</span><br><span class="line">f4e3fcdd8dd4 	renren/fast <span class="string">&quot;java -jar /app.jar&quot;</span> 	55 seconds ago 			Up 3 seconds 	0.0.0.0:8080-&gt;8080/tcp renrenfast_renren-fast_1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#停掉并删除，docker-compose管理的容器</span></span><br><span class="line">[root@mark renren-fast]<span class="comment"># docker-compose down</span></span><br><span class="line">Stopping renrenfast_renren-fast_1 ... <span class="keyword">done</span> </span><br><span class="line">Removing renrenfast_renren-fast_1 ... <span class="keyword">done</span></span><br><span class="line">Removing network renrenfast_default</span><br></pre></td></tr></table></figure>

<h2 id="7-3-集群部署-1"><a href="#7-3-集群部署-1" class="headerlink" title="7.3 集群部署"></a>7.3 集群部署</h2><blockquote>
<p>本系统支持集群部署，集群部署，只需启动多个节点，并配置Nginx即可。</p>
</blockquote>
<ul>
<li>配置Nginx</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    upstream renren &#123;</span><br><span class="line">        server localhost:8080;</span><br><span class="line">        server localhost:8081;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name localhost;</span><br><span class="line">        location /renren-fast &#123;</span><br><span class="line">            proxy_pass http://renren;</span><br><span class="line">            client_max_body_size 1024m;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_redirect off;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过<a target="_blank" rel="noopener" href="http://localhost/renren-fast%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E4%BA%86">http://localhost/renren-fast，就可以访问了</a></li>
</ul>

    </div>

    
    
    


    <div>
      
        <div>
    
      <div style="text-align:center;color: #ccc;font-size:20px;">------------- 本 文 结 束&nbsp&nbsp&nbsp&nbsp&nbsp感 谢 您 的 阅 读 -------------</div>
    
</div>

      
    </div>

    <footer class="post-footer"><div class="post-widgets">
      <div id="needsharebutton-postbottom">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    </div>
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>swimminghao
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://example.com/posts/55ff28b4/" title="renren-fast开发文档3.0最新版">http://example.com/posts/55ff28b4/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/SpringBoot/" rel="tag"><i class="fa fa-tag"></i> SpringBoot</a>
              <a href="/tags/%E8%84%9A%E6%89%8B%E6%9E%B6/" rel="tag"><i class="fa fa-tag"></i> 脚手架</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/79603c56/" rel="prev" title="超详细从0开始搭建 Spring Boot 项目">
                  <i class="fa fa-chevron-left"></i> 超详细从0开始搭建 Spring Boot 项目
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/55ff28b4/" rel="next" title="Spring Boot 2.0 集成 redis">
                  Spring Boot 2.0 集成 redis <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>l






    <div class="comments" id="waline-comments"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">swimminghao</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">998k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">15:07</span>
  </span>
</div>

<span id="sitetime"></span>
<script language=javascript>
    function siteTime(){
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth()+1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2022,02,28,00,00,00); //你的建站时间
        var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
        var diff = t2-t1;
        var diffYears = Math.floor(diff/years);
        var diffDays = Math.floor((diff/days)-diffYears*365);
        var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
        var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
        var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
        document.getElementById("sitetime").innerHTML=" 本站已安全运行 "+diffYears+" Year "+diffDays+" Days "+diffHours+" Hours "+diffMinutes+" m "+diffSeconds+" s";
    }
    siteTime();
</script>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        访问人数：<span id="busuanzi_value_site_uv"></span>
      </span>人
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
       访问总量：<span id="busuanzi_value_site_pv"></span>
      </span>次
    </span>


<!--
  本文总阅读量：<span id="busuanzi_value_page_pv"></span>次
-->

</div>


<!--
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

--><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"waline-server-nu.vercel.app","placeholder":"请文明评论呀","avatar":"mm","pageSize":10,"visitor":false,"comment_count":true,"requiredFields":[],"meta":["nick","mail","link"],"libUrl":"https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js","el":"#waline-comments","path":"/posts/55ff28b4/"}</script>
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() => 
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => {
    new Waline(CONFIG.waline);
  });
});
</script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.js"></script>
  <script>
      pbOptions = {};
        pbOptions.iconStyle = "default";
        pbOptions.boxForm = "horizontal";
        pbOptions.position = "middleCenter";
        pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      new needShareButton('#needsharebutton-postbottom', pbOptions);
  </script>
</body>
</html>
